{
  "createdBy" : "admin@sigma-sbs.com",
  "createdDate" : null,
  "lastModifiedBy" : "admin@sigma-sbs.com",
  "lastModifiedDate" : null,
  "name" : "159d0a78-2cea-4890-8992-30a7645ae244",
  "query" : "declare namespace ia = \"urn:x-emc:ia:schema:fn\";\ndeclare namespace table=\"urn:x-emc:ia:schema:table\";\nimport module namespace sias=\"urn:x-sig:sias:util:fn\";\n\ndeclare variable $page external := 0;\ndeclare variable $size external := 10;\n\n(: Our External Search variable matching the SAP Fieldname :)\ndeclare variable $sBELNR external;\ndeclare variable $sBUKRS external;\ndeclare variable $sGJAHR external;\ndeclare variable $sBUDAT external;\ndeclare function local:getResultsPage($rows, $page, $size)\n{\n\tlet $offset := $page * $size\n  \tlet $total := count($rows)\n  \treturn <results total=\"{ $total }\"> { for $row in subsequence($rows, $offset + 1, $size) return $row }</results>\n};\n\ndeclare function local:addClause($whereClause as xs:string, $var as xs:string*, $expr as xs:string) as xs:string\n{\n\tif (empty($var) or $var = \"\")\n\tthen $whereClause\n\telse if ($whereClause = \"\") then $expr else concat($whereClause, \" and \", $expr)\n};\n\ndeclare function local:codeB($SHKZG, $DMBTR)\n{\nif ($SHKZG = 'S')\nthen\nlet $codeB := $DMBTR\nreturn $codeB\nelse\nlet $codeB := 'N/A'\nreturn $codeB\n};\ndeclare function local:codeC($SHKZG, $DMBTR)\n{\nif ($SHKZG = 'H')\nthen\nlet $codeC := $DMBTR\nreturn $codeC\nelse\nlet $codeC := 'N/A'\nreturn $codeC\n};\n(: Build a conditional Where clause :)\nlet $frDate := replace($sBUDAT/from,'-','')\nlet $toDate := replace($sBUDAT/to,'-','')\nlet $whereClause := local:addClause(\"\", $sBUKRS, concat(\"contains($bkpf/BUKRS, &apos;\", $sBUKRS, \"&apos;)\" ))\nlet $whereClause := local:addClause($whereClause, $sBELNR, concat(\"$bkpf/BELNR = &apos;\", $sBELNR, \"&apos;\"))\nlet $whereClause := local:addClause($whereClause, $sGJAHR, concat(\"$bkpf/GJAHR = &apos;\", $sGJAHR, \"&apos;\"))\nlet $whereClause := local:addClause($whereClause, $frDate, concat(\"$bkpf/BUDAT >= &apos;\", $frDate, \"&apos;\"))\nlet $whereClause := local:addClause($whereClause, $toDate, concat(\"$bkpf/BUDAT <= &apos;\", $toDate, \"&apos;\"))\nlet $whereClause := if ($whereClause != \"\") then concat(\"where \", $whereClause) else $whereClause\n\nlet $query-str := concat(\"for $bkpf in /SAP/BKPF/ROW, $bseg in /SAP/BSEG/ROW[BUKRS = $bkpf/BUKRS and BELNR = $bkpf/BELNR and GJAHR = $bkpf/GJAHR], $t001 in /SAP/T001/ROW[BUKRS = $bkpf/BUKRS],$skat in /SAP/SKAT/ROW[SPRAS = 'EN' and KTOPL = $t001/KTOPL and SAKNR = $bseg/HKONT],$kna1 in /SAP/KNA1/ROW[KUNNR = $bseg/KUNNR] \", $whereClause, \" return <RS><BKPF>{ $bkpf }</BKPF><BSEG>{ $bseg }</BSEG><T001>{ $t001 }</T001><SKAT>{ $skat }</SKAT><KNA1>{ $kna1 }</KNA1></RS>\")\nlet $main-query := xhive:evaluate($query-str)\nlet $rows := \n\tfor $rs in $main-query\n    let $BLDAT := sias:showdate($rs/BKPF/ROW/BLDAT/text())\n    let $BUDAT := sias:showdate($rs/BKPF/ROW/BUDAT/text())\n   \n    let $codeB := local:codeB($rs/BSEG/ROW/SHKZG/text(),$rs/BSEG/ROW/DMBTR/text())\n    let $codeC := local:codeC($rs/BSEG/ROW/SHKZG/text(),$rs/BSEG/ROW/DMBTR/text())\n    let $WAERS := sias:get_t001($rs/BKPF/ROW/BUKRS/text(), 'WAERS')\n    return\n\n<row id='{string($rs/BKPF/ROW/@table:id)}'>\n<column name='cBELNR'>{ $rs/BKPF/ROW/BELNR/text() }</column>\n<column name='cBUDAT'>{ $BUDAT }</column>\n<column name='cBLDAT'>{ $BLDAT }</column>\n<column name='cBLART'>{ $rs/BKPF/ROW/BLART/text() }</column>\n<column name='cXBLNR'>{ $rs/BKPF/ROW/XBLNR/text() }</column>\n<column name='cBKTXT'>{ $rs/BKPF/ROW/BKTXT/text() }</column>\n<column name='cBUZEI'>{ $rs/BSEG/ROW/BUZEI/text() }</column>\n<column name='cKOART'>{ $rs/BSEG/ROW/KOART/text() }</column>\n<column name='cGSBER'>{ $rs/BSEG/ROW/GSBER/text() }</column>\n<column name='cBSCHL'>{ $rs/BSEG/ROW/BSCHL/text() }{' '}{$rs/BSEG/ROW/UMSKZ/text()}</column>\n<column name='cWRBTR'>{ $rs/BKPF/ROW/BLART/text() }</column>\n<column name='cWAERS'>{ $WAERS }</column>\n\n\n<column name='cTXT20'>{ $rs/SKAT/ROW/TXT20/text() }</column>\n<column name='cNAME1'>{ $rs/KNA1/ROW/NAME1/text() }</column>\n<column name='cKUNNR'>{ $rs/BSEG/ROW/KUNNR/text() }</column>\n<column name='cHKONT'>{ $rs/BSEG/ROW/HKONT/text() }</column>\n<column name='cDMBTR'>{ $codeB }</column>\n<column name='cDMBTR1'>{ $codeC }</column>\n\n</row>\n\nreturn local:getResultsPage($rows, $page, $size)",
  "moduleNamespaces" : [ "urn:x-sig:sias:util:fn" ],
  "searchName" : "S_ALR_87012287 - Document Journal",
  "compositionName" : "Set 1"
}