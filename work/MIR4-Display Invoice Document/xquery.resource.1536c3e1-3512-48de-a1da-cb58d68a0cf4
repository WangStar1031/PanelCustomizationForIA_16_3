{
  "createdBy" : "admin@sigma-sbs.com",
  "createdDate" : null,
  "lastModifiedBy" : "admin@sigma-sbs.com",
  "lastModifiedDate" : null,
  "name" : "fdef22f4-9e7a-46fc-8b22-e63737d83605",
  "query" : "declare namespace ia = \"urn:x-emc:ia:schema:fn\";\ndeclare namespace table=\"urn:x-emc:ia:schema:table\";\nimport module namespace sias=\"urn:x-sig:sias:util:fn\";\n\ndeclare variable $page external;\ndeclare variable $size external;\n\n(: Our External Search variable matching the SAP Fieldname :)\ndeclare variable $sBELNR external;\ndeclare variable $sGJAHR external;\n\ndeclare function local:getResultsPage($rows, $page, $size) {\n  let $offset := $page * $size\n  let $total := count($rows)\n  return <results total=\"{ $total }\"> {\n    for $row in subsequence($rows, $offset + 1, $size)\n      return $row\n  } </results>\n};\n\ndeclare function local:addClause($whereClause as xs:string, $var as xs:string*, $expr as xs:string) as xs:string\n{\nif (empty($var) or $var = \"\")\nthen $whereClause\nelse if ($whereClause = \"\") then $expr else concat($whereClause, \" and \", $expr)\n};\n\ndeclare function local:get_ekbe($ebeln,$ebelp,$vgabe,$output)\n{\n      switch ($output)\n            case \"MENGE\" return for $ekbe in /SAP/EKBE/ROW[EBELN=$ebeln and EBELP=$ebelp and VGABE=$vgabe] return $ekbe/MENGE/text()\n            case \"BPMNG\" return for $ekbe in /SAP/EKBE/ROW[EBELN=$ebeln and EBELP=$ebelp and VGABE=$vgabe] return $ekbe/BPMNG/text()\n            default return \"\"\n};\n\n\n\n(: Build a conditional Where clause :)\n\nlet $whereClause := local:addClause(\"\", $sBELNR, concat(\"contains($rbkp/BELNR, &apos;\", $sBELNR, \"&apos;)\" ))\nlet $whereClause := local:addClause($whereClause, $sGJAHR, concat(\"$rbkp/GJAHR = &apos;\", $sGJAHR, \"&apos;\"))\nlet $whereClause := if ($whereClause != \"\") then concat(\"where \", $whereClause) else $whereClause\n\nlet $query-str := concat(\"for $rbkp in /SAP/RBKP/ROW, $rseg in /SAP/RSEG/ROW[BELNR = $rbkp/BELNR and GJAHR = $rbkp/GJAHR], $ekko in /SAP/EKKO/ROW[EBELN=$rseg/EBELN], $ekpo in /SAP/EKPO/ROW[EBELN = $rseg/EBELN and EBELP = $rseg/EBELP], $eket in /SAP/EKET/ROW[EBELN = $ekpo/EBELN and EBELP = $ekpo/EBELP] \" ,$whereClause, \" return <RS><EKKO>{ $ekko }</EKKO><RBKP>{ $rbkp }</RBKP><EKET>{ $eket }</EKET><EKPO>{ $ekpo }</EKPO><RSEG>{ $rseg }</RSEG></RS>\")\n\nlet $main-query := xhive:evaluate($query-str)\n\nlet $rows := \n               for $rs in $main-query\n                  \n               let $WEMNG := local:get_ekbe($rs/RSEG/ROW/EBELN/text(), $rs/RSEG/ROW/EBELP/text(),'1','MENGE')\n               let $BPWEM := local:get_ekbe($rs/RSEG/ROW/EBELN/text(), $rs/RSEG/ROW/EBELP/text(),'1','BPMNG')\n               let $REMNG := local:get_ekbe($rs/RSEG/ROW/EBELN/text(), $rs/RSEG/ROW/EBELP/text(),'2','MENGE')\n               let $BPREM := local:get_ekbe($rs/RSEG/ROW/EBELN/text(), $rs/RSEG/ROW/EBELP/text(),'2','BPMNG')\n\nreturn\n<row id='{string($rs/RBKP/ROW/@table:id)}'>\n<column name='cBUZEI'>{ $rs/RSEG/ROW/BUZEI/text() }</column>\n<column name='cWRBTR'>{ $rs/RSEG/ROW/WRBTR/text() }</column>\n<column name='cMENGE'>{ $rs/RSEG/ROW/MENGE/text() }</column>\n<column name='cMEINS'>{ $rs/RSEG/ROW/MEINS/text() }</column>\n<column name='cEBELN'>{ $rs/RSEG/ROW/EBELN/text() }</column>\n<column name='cEBELP'>{ $rs/RSEG/ROW/EBELP/text() }</column>\n\n<column name='cTXZ01'>{ $rs/EKPO/ROW/TXZ01/text() }</column>\n<column name='cKNTTP'>{ $rs/EKPO/ROW/KNTTP/text() }</column>\n\n<column name='cSAKNR'>{ $rs/RBCO/ROW/SAKNR/text() }</column>\n<column name='cGSBER'>{ $rs/RBCO/ROW/GSBER/text() }</column>\n<column name='cKOSTL'>{ $rs/RBCO/ROW/KOSTL/text() }</column>\n\n<column name='cFIPOS'>{ $rs/EKPO/ROW/FIPOS/text() }</column>\n\n<column name='cFKBER'>{ $rs/RBCO/ROW/FKBER/text() }</column>\n\n<column name='cPRCTR'>{ $rs/EKPO/ROW/PRCTR/text() }</column>\n\n<column name='cKOKRS'>{ $rs/RBCO/ROW/KOKRS/text() }</column>\n\n<column name='cBRPME'>{ $rs/RSEG/ROW/BRPME/text() }</column>\n\n<column name='cNETPR'>{ $rs/EKPO/ROW/NETPR/text() }</column>\n\n<column name='cWAERS'>{ $rs/EKKO/ROW/WAERS/text() }</column>\n\n<column name='cPEINH'>{ $rs/EKPO/ROW/PEINH/text() }</column>\n\n<column name='cLFPOS'>{ $rs/RSEG/ROW/LFPOS/text() }</column>\n<column name='cLFBNR'>{ $rs/RSEG/ROW/LFBNR/text() }</column>\n\n<column name='cINCO1'>{ $rs/EKKO/ROW/INCO1/text() }</column>\n<column name='cMATNR'>{ $rs/RSEG/ROW/MATNR/text() }</column>\n<column name='cMATKL'>{ $rs/EKPO/ROW/MATKL/text() }</column>\n<column name='cWERKS'>{ $rs/RSEG/ROW/WERKS/text() }</column>\n<column name='cBWKEY'>{ $rs/RSEG/ROW/BWKEY/text() }</column>\n<column name='cMATBF'>{ $rs/RSEG/ROW/MATBF/text() }</column>\n<column name='cTBTKZ'>{ $rs/RSEG/ROW/TBTKZ/text() }</column>\n<column name='cEINDT'>{ $rs/EKET/ROW/EINDT/text() }</column>\n<column name='cERNAM'>{ $rs/EKKO/ROW/ERNAM/text() }</column>\n<column name='cSHKZG'>{ $rs/RSEG/ROW/SHKZG/text() }</column>\n<column name='cMENGE3'>{ $rs/EKPO/ROW/MENGE/text() }</column>\n\n\n<column name='cWEMNG'>{ $WEMNG }</column>\n<column name='cBPWEM'>{ $BPWEM }</column>\n<column name='cREMNG'>{ $REMNG }</column>\n<column name='cBPREM'>{ $BPREM }</column>\n</row>\n\nreturn local:getResultsPage($rows, $page, $size)",
  "moduleNamespaces" : [ "urn:x-sig:sias:util:fn" ],
  "searchName" : "MIR4-Display invoice Document items",
  "compositionName" : "MIR4 Nested"
}