{
  "createdBy" : "admin@sigma-sbs.com",
  "createdDate" : null,
  "lastModifiedBy" : "admin@sigma-sbs.com",
  "lastModifiedDate" : null,
  "name" : "473d3938-808f-457c-be6d-b0a59a5647ad",
  "query" : "declare namespace ia = \"urn:x-emc:ia:schema:fn\";\ndeclare namespace table=\"urn:x-emc:ia:schema:table\";\nimport module namespace sias=\"urn:x-sig:sias:util:fn\";\n\ndeclare variable $page external;\ndeclare variable $size external;\n\n(: Our External Search variable matching the SAP Fieldname :)\ndeclare variable $sBELNR external;\ndeclare variable $sGJAHR external;\n\ndeclare function local:getResultsPage($rows, $page, $size) {\n  let $offset := $page * $size\n  let $total := count($rows)\n  return <results total=\"{ $total }\"> {\n    for $row in subsequence($rows, $offset + 1, $size)\n      return $row\n  } </results>\n};\n\ndeclare function local:get_xrech($XRECH, $TBTKZ, $INV)\n{\n\nif ( $XRECH = \" \" or not(exists($XRECH)) ) then (if($TBTKZ = \" \" or not(exists($TBTKZ))) then \"2 Credit memo\" else \"4 Subsequent credit\")\nelse if($TBTKZ = \" \" or not(exists($TBTKZ))) then \"1 Invoice\" else if($INV = \"5\" or $INV = \"6\" or $INV = \"7\") then $INV\nelse \"3 Subsequent debit\"\n\n};\n\ndeclare function local:get_mwskz1($MWSKZ1)\n{\n\t\tswitch ($MWSKZ1)\n\tcase \"01\" return \"I0 (A/P Tax Exempt)\"\n    case \"02\" return \"I1 (A/P Sales Tax)\"\n    case \"03\" return \"S0 ()\"\n    case \"04\" return \"S1 ()\"\n    case \"05\" return \"U0 (A/P Tax Exempt)\"\n    case \"06\" return \"V1 (15% Domestic In)\"\n    \tdefault return \"\t\"\n};\n\ndeclare function local:get_ltext($LTEXT)\n{\n\t\tswitch ($LTEXT)\n\tcase \"01\" return \"Gross inv. Receipt\"\n    case \"02\" return \"Net Invoice Receipt\"\n    case \"03\" return \"RR\"\n    case \"04\" return \"G/L Account Document\"\n    case \"05\" return \"Subseqnt Debit Doc.\"\n    case \"06\" return \"Vendor Invoice\"\n    case \"07\" return \"Vendor Payment\"\n    case \"08\" return \"Recurring Entry Doc\"\n    case \"09\" return \"Sample Doc\"\n    case \"10\" return \"Asset Post. Period\"\n    case \"11\" return \"High Tech IPM OR\"\n    case \"12\" return \"Intracompagny Docs\"\n    case \"13\" return \"Payment Posting\"\n    case \"14\" return \"Payment Clearing\"\n    \tdefault return \"Gross inv. Receipt\"\n};\n\n\ndeclare function local:get_inv($result, $XRECH)\n{\n\nif($result = \"5\" or $result = \"6\" or $result = \"7\") then (if($XRECH = \"X\") then \"1 As invoice\" else \"2 as Credit memo\")\nelse \"Not Applicable\"\n\n};\n\ndeclare function local:addClause($whereClause as xs:string, $var as xs:string*, $expr as xs:string) as xs:string\n{\nif (empty($var) or $var = \"\")\nthen $whereClause\nelse if ($whereClause = \"\") then $expr else concat($whereClause, \" and \", $expr)\n};\n\n(: Build a conditional Where clause :)\n\nlet $whereClause := local:addClause(\"\", $sBELNR, concat(\"contains($rbkp/BELNR, &apos;\", $sBELNR, \"&apos;)\" ))\nlet $whereClause := local:addClause($whereClause, $sGJAHR, concat(\"$rbkp/GJAHR = &apos;\", $sGJAHR, \"&apos;\"))\nlet $whereClause := if ($whereClause != \"\") then concat(\"where \", $whereClause) else $whereClause\n\n\nlet $query-str := concat(\"for $rbkp in /SAP/RBKP/ROW, $lfa1 in /SAP/LFA1/ROW[LIFNR=$rbkp/LIFNR] \" , $whereClause, \" return <RS><RBKP>{ $rbkp }</RBKP><LFA1>{ $lfa1 }</LFA1></RS>\")\n\nlet $main-query := xhive:evaluate($query-str)\n\nlet $rows := \n               for $rs in $main-query\n               let $result := local:get_xrech($rs/RBKP/ROW/XRECH/text(), $rs/RSEG/ROW/TBTKZ/text(), $rs/RBKP/ROW/INV_TRAN/text())\n\t\t\t   let $result2 := local:get_inv($result, $rs/RBKP/ROW/XRECH/text())\n               let $BUTXT := sias:get_t001($rs/RBKP/ROW/BUKRS/text(), 'BUTXT')\n               let $ORT01 := sias:get_t001($rs/RBKP/ROW/BUKRS/text(), 'ORT01')\n               let $LAND1 := sias:get_t001($rs/RBKP/ROW/BUKRS/text(), \"LAND1\")\n               let $KALSM := sias:get_t005($LAND1, \"KALSM\")\n               let $TAXCODE := sias:get_t007s($KALSM, $rs/RBKP/ROW/MWSKZ1/text())\n               let $BLDAT := sias:showdate($rs/RBKP/ROW/BLDAT/text())       \n\t\t\t   let $BUDAT := sias:showdate($rs/RBKP/ROW/BUDAT/text())   \n               let $ZFBDT := sias:showdate($rs/RBKP/ROW/ZFBDT/text()) \n               let $LIFNR := sias:trimzero($rs/RBKP/ROW/LIFNR/text())\n               let $LTEXT := local:get_ltext($rs/T003T/ROW/LTEXT/text())\n               let $MWSKZ1 := local:get_mwskz1($rs/RBKP/ROW/MWSKZ1/text())\n               let $PBLOCK := sias:get_t008t($rs/RBKP/ROW/ZLSPR/text())\n           \n               \n\nreturn\n<row id='{string($rs/RBKP/ROW/@table:id)}'>\n<column name='cTransaction'>{$result}</column>\n<column name='cBELNR'>{ $rs/RBKP/ROW/BELNR/text() }</column>\n<column name='cGJAHR'>{ $rs/RBKP/ROW/GJAHR/text() }</column>\n<column name='cPOSTING'>{$result2}</column>\n<column name='cNAME1'>{ $rs/LFA1/ROW/NAME1/text() }</column>\n<column name='cSTRAS'>{ $rs/LFA1/ROW/STRAS/text() }</column>\n<column name='cPSTLZ'>{ $rs/LFA1/ROW/PSTLZ/text() }</column>\n<column name='cSORTL'>{ $rs/LFA1/ROW/SORTL/text() }</column>\n<column name='cTELF1'>{ $rs/LFA1/ROW/TELF1/text() }</column>\n<column name='cTELFX'>{ $rs/LFA1/ROW/TELFX/text() }</column>\n<column name='cINTAD'>{ $rs/LFA1/ROW/INTAD/text() }</column>\n\n<column name='cBLDAT'>{ $BLDAT }</column>\n<column name='cBUDAT'>{ $BUDAT }</column>\n<column name='cRMWWR'>{ $rs/RBKP/ROW/RMWWR/text() } {'     '} { $rs/RBKP/ROW/WAERS/text() }</column>\n<column name='cXMWST'>{ $rs/RBKP/ROW/XMWST/text() }</column>\n<column name='cWMWST1'>{ $rs/RBKP/ROW/WMWST1/text() }{'     '} { $MWSKZ1 }</column>\n<column name='cSGTXT'>{ $rs/RBKP/ROW/SGTXT/text() }</column>\n<column name='cXBLNR'>{ $rs/RBKP/ROW/XBLNR/text() }</column>\n<column name='cCMPC'>{ $rs/RBKP/ROW/BUKRS/text()}{'\t\t'}{ $BUTXT }{'     '}{ $ORT01 }</column>\n\n<column name='cZFBDT1'>{ $ZFBDT }</column>\n\n<column name='cPayTerm'>{ $rs/RBKP/ROW/ZBD1T/text()}{' day(s)'}</column>\n\n<column name='cLOTKZ'>{ $rs/BKPF/ROW/LOTKZ/text() }</column>\n<column name='cBUPLA'>{ $rs/RBKP/ROW/BUPLA/text() }</column>\n<column name='cSECCO'>{ $rs/RBKP/ROW/SECCO/text() }</column>\n<column name='cBRNCH'>{ $rs/RBKP/ROW/BRNCH/text() }</column>\n<column name='cNUMPG'>{ $rs/BKPF/ROW/NUMPG/text() }</column>\n<column name='cZFBDT2'>{ $ZFBDT }</column>\n<column name='cZTERM'>{ $rs/RBKP/ROW/ZTERM/text() }</column>\n<column name='cZBD1T'>{ $rs/RBKP/ROW/ZBD1T/text() }</column>\n<column name='cZBD1P'>{ $rs/RBKP/ROW/ZBD1P/text() }</column>\n\n<column name='cZBD2T'>{ $rs/RBKP/ROW/ZBD2T/text() }</column>\n<column name='cZBD2P'>{ $rs/RBKP/ROW/ZBD2P/text() }</column>\n<column name='cWSKTO'>{ $rs/RBKP/ROW/WSKTO/text() }{ '     ' }{ $rs/RBKP/ROW/WAERS/text() }</column>\n<column name='cZBD3T'>{ $rs/RBKP/ROW/ZBD3T/text() }</column>\n<column name='cZBFIX'>{ $rs/RBKP/ROW/ZBFIX/text() }</column>\n<column name='cZLSCH'>{ $rs/RBKP/ROW/ZLSCH/text() }</column>\n<column name='cREBZG'>{ $rs/RBKP/ROW/REBZG/text() } { '     ' } { $rs/RBKP/ROW/RBZJ/text() }</column>\n<column name='cBVTYP'>{ $rs/RBKP/ROW/BVTYP/text() }</column>\n<column name='cHBKID'>{ $rs/RBKP/ROW/HBKID/text() } / { $rs/RBKP/ROW/RBZJ/text() }</column>\n<column name='cBEZNK'>{ $rs/RBKP/ROW/BEZNK/text() }</column>\n<column name='cWAERS'>{ $rs/RBKP/ROW/WAERS/text() }</column>\n<column name='cKURSF'>{ $rs/RBKP/ROW/KURSF/text() }</column>\n\n\n<column name='cLTEXT'>{ $LTEXT }</column>\n\n\n<column name='cLIFNR'>{ $LIFNR }</column>\n<column name='cTXJCD'>{ $rs/RSEG/ROW/TXJCD/text() }</column>\n<column name='cGSBER'>{ $rs/RBKP/ROW/GSBER/text() }</column>\n<column name='cZUONR'>{ $rs/RBKP/ROW/ZUONR/text() }</column>\n<column name='cHKONT'>{ $rs/RBKP/ROW/HKONT/text() }</column>\n<column name='cBKTXT'>{ $rs/RBKP/ROW/BKTXT/text() }</column>\n<column name='cEGMLD'>{ $rs/RBKP/ROW/EGMLD/text() }</column>\n<column name='cSTCEG'>{ $rs/RBKP/ROW/STCEG/text() }</column>\n<column name='cXEGDR'>{ $rs/RBKP/ROW/XEGDR/text() }</column>\n<column name='cFDLEV'>{ $rs/RBKP/ROW/FDLEV/text() }</column>\n<column name='cFDTAG'>{ $rs/RBKP/ROW/FDTAG/text() }</column>\n<column name='cSHKZG'>{ $rs/RSEG/ROW/SHKZG/text() }</column>\n\n<column name='cMWSKZ1'>{ $rs/RBKP/ROW/MWSKZ1/text() }{'\t'}{ $rs/RBKP/ROW/WAERS/text() }</column>\n\n<column name='cXMWST'>{ $rs/RBKP/ROW/XMWST/text() }</column>\n<column name='cWMWST1'>{ $rs/RBKP/ROW/WMWST1/text() }{'     '}{ $rs/RBKP/ROW/WAERS/text() }</column>\n<column name='cWT_WITHCD'>{ $rs/RBWS/ROW/WT_WITHCD/text() }</column>\n<column name='cWT_QSSHB'>{ $rs/RBWS/ROW/WT_QSSHB/text() }</column>\n<column name='cWT_QBUIHB'>{ $rs/RBWS/ROW/WT_QBUIHB/text() }</column>\n<column name='cWT_WITHT'>{ $rs/RBWS/ROW/WT_WITHT/text() }</column>\n<column name='cWT_EXNR'>{ $rs/RBWS/ROW/WT_EXNR/text() }</column>\n\n<column name='cFDLEV1'>{ $rs/RBKP/ROW/FDLEV/text() }</column>\n<column name='cEGMLD1'>{ $rs/RBKP/ROW/EGMLD/text() }</column>\n<column name='cSTCEG1'>{ $rs/RBKP/ROW/STCEG/text() }</column>\n<column name='cXEGDR1'>{ $rs/RBKP/ROW/XEGDR/text() }</column>\n<column name='cBUPLA1'>{ $rs/RBKP/ROW/BUPLA/text() }</column>\n<column name='cBRNCH1'>{ $rs/RBKP/ROW/BRNCH/text() }</column>\n<column name='cNUMPG1'>{ $rs/RBKP/ROW/NUMPG/text() }</column>\n\n<column name='cPBLOCK'>{ $PBLOCK }</column>\n\n<column name='cBUZEI'>{ $rs/RSEG/ROW/BUZEI/text() }</column>\n<column name='cTXZ01'>{ $rs/EKPO/ROW/TXZ01/text() }</column>\n<column name='cREQUIES'>{ $rs/EKPO/ROW/AFNAM/text() }</column>\n<column name='cBUYER'>{ $rs/EKKO/ROW/ERNAM/text() }</column>\n\n</row>\n\nreturn local:getResultsPage($rows, $page, $size)",
  "moduleNamespaces" : [ "urn:x-sig:sias:util:fn" ],
  "searchName" : "MIR4-Display Invoice Document",
  "compositionName" : "MIR4"
}