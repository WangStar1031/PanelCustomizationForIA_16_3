{
  "createdBy" : "admin@sigma-sbs.com",
  "createdDate" : null,
  "lastModifiedBy" : "admin@sigma-sbs.com",
  "lastModifiedDate" : null,
  "name" : "25a32f79-2bf9-4daa-9508-c99478f31b54",
  "query" : "declare option xhive:index-debug 'true';\ndeclare option xhive:queryplan-debug 'true';\ndeclare option xhive:pathexpr-debug 'true';\n\ndeclare namespace ia = \"urn:x-emc:ia:schema:fn\";\ndeclare namespace table=\"urn:x-emc:ia:schema:table\";\n\nimport module namespace sias=\"urn:x-sig:sias:util:fn\";\n\ndeclare variable $page external;\ndeclare variable $size external;\n\n(: Our External Search variable matching the SAP Fieldname :)\ndeclare variable $sKUNNR external;\ndeclare variable $sBUKRS external;\ndeclare variable $sVKORG external;\ndeclare variable $sVTWEG external;\ndeclare variable $sSPART external;\n\ndeclare function local:getResultsPage($rows, $page, $size) {\n  let $offset := $page * $size\n  let $total := count($rows)\n  return <results total=\"{ $total }\"> {\n    for $row in subsequence($rows, $offset + 1, $size)\n      return $row\n  } </results>\n};\n\ndeclare function local:get_tvkbt($TVKBT)\n{\n      if ($TVKBT = \"A\") then \"Create a delivery with qty greater than zero\" \n      else if ($TVKBT = \"B\") then \"Create only one delivery (also with qty = 0)\"\n      else if ($TVKBT = \"C\") then \"Only complete delivery allowed\"\n      else if ($TVKBT = \"D\") then \"No limit to subsequent deliveries\"\n      else \"Partial delivery allowed\"\n};\n\n\ndeclare function local:addClause($whereClause as xs:string, $var as xs:string*, $expr as xs:string) as xs:string\n{\nif (empty($var) or $var = \"\")\nthen $whereClause\nelse if ($whereClause = \"\") then $expr else concat($whereClause, \" and \", $expr)\n};\n\n(: Build a conditional Where clause :)\nlet $whereClause := local:addClause(\"\", $sKUNNR, concat(\"$knb1/KUNNR = &apos;\", $sKUNNR, \"&apos;\" ))\nlet $whereClause := local:addClause($whereClause, $sBUKRS, concat(\"$knb1/BUKRS = &apos;\", $sBUKRS, \"&apos;\"))\nlet $whereClause := local:addClause($whereClause, $sVKORG, concat(\"$knvv/VKORG = &apos;\", $sVKORG, \"&apos;\"))\nlet $whereClause := local:addClause($whereClause, $sVTWEG, concat(\"$knvv/VTWEG = &apos;\", $sVTWEG, \"&apos;\"))\nlet $whereClause := local:addClause($whereClause, $sSPART, concat(\"$knvv/SPART = &apos;\", $sSPART, \"&apos;\"))\nlet $whereClause := if ($whereClause != \"\") then concat(\"where \", $whereClause) else $whereClause\n\nlet $query-str := concat(\"for $knb1 in /SAP/KNB1/ROW, $knvv in /SAP/KNVV/ROW[KUNNR = $knb1/KUNNR], $kna1 in /SAP/KNA1/ROW[KUNNR = $knb1/KUNNR], $adrc in /SAP/ADRC/ROW[ADDRNUMBER = $kna1/ADRNR]\", $whereClause, \"return <RS><ADRC>{ $adrc }</ADRC><KNB1>{ $knb1 }</KNB1><KNVV>{ $knvv }</KNVV><KNA1>{ $kna1 }</KNA1></RS>\")\n\nlet $main-query := xhive:evaluate($query-str)\n\nlet $rows := \n\tfor $rs in $main-query\n    \nlet $TFACT := sias:get_tfact($rs/KNVV/ROW/PERFK/text())\nlet $T016T := sias:get_t016t($rs/KNA1/ROW/BRSCH/text())\nlet $TZONT := sias:get_tzont($rs/KNA1/ROW/LAND1, $rs/KNA1/ROW/LZONE/text())\nlet $TVZBT := sias:get_tvzbt($rs/KNVV/ROW/ZTERM/text())\nlet $TVKTT := sias:get_tvktt($rs/KNVV/ROW/KTGRD/text())\nlet $TZUNT := sias:get_tzunt($rs/KNB1/ROW/ZUAWA/text())\nlet $T001 := sias:get_t001($rs/KNB1/ROW/BUKRS/text(), \"BUTXT\")\nlet $TVKOT := sias:get_tvkot($rs/KNVV/ROW/VKORG/text())\nlet $TVTWT := sias:get_tvtwt($rs/KNVV/ROW/VTWEG/text())\nlet $TSPAT := sias:get_tspat($rs/KNVV/ROW/SPART/text())\nlet $T035T := sias:get_t035t($rs/KNB1/ROW/FDGRV/text() , 'TEXTK')\nlet $WAERS := sias:get_t001($rs/KNB1/ROW/BUKRS/text(), \"WAERS\")\nlet $T171T := sias:get_t171t($rs/KNVV/ROW/BZIRK/text())\nlet $TVKBT := sias:get_tvkbt($rs/KNVV/ROW/VKBUR/text())\nlet $TVGRT := sias:get_tvgrt($rs/KNVV/ROW/VKGRP/text())\nlet $T151T := sias:get_t151t($rs/KNVV/ROW/KDGRP/text())\nlet $TCURT := sias:get_tcurt($rs/KNVV/ROW/WAERS/text())\nlet $TVKDT := sias:get_tvkdt($rs/KNVV/ROW/KALKS/text())\nlet $TVSDT := sias:get_tvsdt($rs/KNVV/ROW/VERSG/text())\nlet $TKUKT := sias:get_tkukt($rs/KNA1/ROW/KUKLA/text())\n\nlet $TPRIT := sias:get_tprit($rs/KNVV/ROW/LPRIO/text())\nlet $TVSBT := sias:get_tvsbt($rs/KNVV/ROW/VSBED/text())\n\nlet $TVKBT := local:get_tvkbt($rs/KNVV/ROW/KZTLF/text())\n\nlet $KUNNR_trim := sias:trimzero($rs/KNVV/ROW/KUNNR/text())\nlet $AKONT_trim := sias:trimzero($rs/KNB1/ROW/AKONT/text())\nlet $PERNR := sias:trimzero($rs/KNB1/ROW/PERNR/text())\nlet $zone := sias:trimzero($rs/KNA1/ROW/LZONE/text())\n\nlet $T005T := sias:get_t005t($rs/KNA1/ROW/LAND1/text(), 'LANDX')\nlet $T005U := sias:get_t005u($rs/KNA1/ROW/LAND1/text(), $rs/KNA1/ROW/REGIO/text())\n\nlet $UMSA1 := sias:currency($rs/KNA1/ROW/UMSA1/text(), \"\")\nlet $UMJAH := sias:shownumber($rs/KNA1/ROW/UMJAH/text(), \"\")\nlet $JMZAH := sias:shownumber($rs/KNA1/ROW/JMZAH/text(), \"\")\nlet $JMJAH := sias:shownumber($rs/KNA1/ROW/JMJAH/text(), \"\")\nlet $WEBTR := sias:currency($rs/KNB1/ROW/WEBTR/text(), \"\")\nlet $VLIBB := sias:currency($rs/KNB1/ROW/VLIBB/text(), \"\")\n\nlet $ZINDT := sias:showdate($rs/KNA1/ROW/ZINDT/text())\nlet $DATLZ := sias:showdate($rs/KNA1/ROW/DATLZ/text())\n\nreturn \n<row id='{string($rs/KNA1/ROW/@table:id)}'>\n<column name='cKUNNR1'>{ $rs/KNVV/ROW/KUNNR/text() }{ '     ' }{ $rs/KNA1/ROW/NAME1/text() }{ '     ' }{ $rs/KNA1/ROW/ORT01/text() }</column>\n<column name='cBUKRS1'>{ $rs/KNB1/ROW/BUKRS/text() }{ '     ' }{ $T001 }</column>\n<column name='cVKORG1'>{ $rs/KNVV/ROW/VKORG/text() }{ '     ' }{ $TVKOT }</column>\n<column name='cVTWEG1'>{ $rs/KNVV/ROW/VTWEG/text() }{ '     ' }{ $TVTWT }</column>\n<column name='cSPART1'>{ $rs/KNVV/ROW/SPART/text() }{ '     ' }{ $TSPAT }</column>\n\n<column name='cKUNNR'>{ $rs/KNVV/ROW/KUNNR/text() }</column>\n<column name='cBUKRS'>{ $rs/KNB1/ROW/BUKRS/text() }</column>\n<column name='cVKORG'>{ $rs/KNVV/ROW/VKORG/text() }</column>\n<column name='cVTWEG'>{ $rs/KNVV/ROW/VTWEG/text() }</column>\n<column name='cSPART'>{ $rs/KNVV/ROW/SPART/text() }</column>\n\n\n<column name='cTITLE3'>{ $rs/ADRC/ROW/TITLE/text() }</column>\n<column name='cNAME3'>{ $rs/KNA1/ROW/NAME1/text() }</column>\n<column name='cSTRAS3'>{ $rs/KNA1/ROW/STRAS/text() }</column>\n<column name='cPOSHS3'>{ $rs/KNA1/ROW/ADRNR/text() }</column>\n<column name='cORT04'>{ $rs/KNA1/ROW/ORT01/text() }</column>\n<column name='cTXJCD3'>{ $rs/KNA1/ROW/TXJCD/text() }</column>\n<column name='cPSTLZ3'>{ $rs/KNA1/ROW/PSTLZ/text() }</column>\n<column name='cTransZone'>{ $zone }{'     '}{ $TZONT }</column>\n<column name='cORT03'>{ $rs/KNA1/ROW/ORT01/text() }</column>\n<column name='cLAND3'>{ $rs/KNA1/ROW/LAND1/text() }{'      '}{ $T005T }</column>\n<column name='cREGIO3'>{ $rs/KNA1/ROW/REGIO/text() }{'      '}{ $T005U }</column>\n<column name='cPFACH3'>{ $rs/KNA1/ROW/PFACH/text() }</column>\n<column name='cPSTL23'>{ $rs/KNA1/ROW/PSTL2/text() }</column>\n<column name='cSPRAS3'>{ $rs/KNA1/ROW/SPRAS/text() }</column>\n<column name='cTELF3'>{ $rs/KNA1/ROW/TELF1/text() }</column>\n<column name='cTELFX'>{ $rs/KNA1/ROW/TELFX/text() }</column>\n<column name='cTEL_EXTENS'>{ $rs/ADR2/ROW/TEL_EXTENS/text() }</column>\n<column name='cFAX_EXTENS'>{ $rs/ADR3/ROW/FAX_EXTENS/text() }</column>\n<column name='cSMTP_ADDR'>{ $rs/ADR6/ROW/SMTP_ADDR/text() }</column>\n<column name='cEXTENSION1'>{ $rs/ADRC/ROW/EXTENSION1/text() }</column>\n<column name='cEXTENSION2'>{ $rs/ADRC/ROW/EXTENSION2/text() }</column>\n\n\n<column name='cLIFNR'>{ $rs/KNA1/ROW/LIFNR/text() }</column>\n<column name='cVBUND'>{ $rs/KNA1/ROW/VBUND/text() }</column>\n<column name='cBEGRU'>{ $rs/KNA1/ROW/BEGRU/text() }</column>\n<column name='cKONZS'>{ $rs/KNA1/ROW/KONZS/text() }</column>\n<column name='cBBBNR'>{ $rs/KNA1/ROW/BBBNR/text() }</column>\n<column name='cIndustry'>{ $rs/KNA1/ROW/BRSCH/text() }{'      '}{ $T016T }</column>\n<column name='cBAHNS'>{ $rs/KNA1/ROW/BAHNS/text() }</column>\n<column name='cBAHNE'>{ $rs/KNA1/ROW/BAHNE/text() }</column>\n<column name='cTransport'>{ $rs/KNA1/ROW/LZONE/text() }{'     '}{ $TZONT }</column>\n<column name='cBBSNR'>{ $rs/KNA1/ROW/BBSNR/text() }</column>\n<column name='cBUBKZ'>{ $rs/KNA1/ROW/BUBKZ/text() }</column>\n<column name='cLOCCO'>{ $rs/KNA1/ROW/LOCCO/text() }</column>\n<column name='cSTCD1'>{ $rs/KNA1/ROW/STCD1/text() }</column>\n<column name='cSTCD2'>{ $rs/KNA1/ROW/STCD2/text() }</column>\n<column name='cFISKN'>{ $rs/KNA1/ROW/FISKN/text() }</column>\n<column name='cCOUNC'>{ $rs/KNA1/ROW/COUNC/text() }</column>\n<column name='cCITYC'>{ $rs/KNA1/ROW/CITYC/text() }</column>\n<column name='cSTCEG'>{ $rs/KNA1/ROW/STCEG/text() }</column>\n<column name='cTXJCD'>{ $rs/KNA1/ROW/TXJCD/text() }</column>\n<column name='cSTKZA'>{ $rs/KNA1/ROW/STKZA/text() }</column>\n<column name='cSTKZN'>{ $rs/KNA1/ROW/STKZN/text() }</column>\n<column name='cSTKZU'>{ $rs/KNA1/ROW/STKZU/text() }</column>\n\n<column name='cNIELS'>{ $rs/KNA1/ROW/NIELS/text() }</column>\n<column name='cCustomer'>{ $rs/KNA1/ROW/KUKLA/text() }{'     ' }{ $TKUKT }</column>\n<column name='cIndus'>{ $rs/KNA1/ROW/BRSCH/text() }{ '      ' }{ $T016T }</column>\n<column name='cBRAN1'>{ $rs/KNA1/ROW/BRAN1/text() }</column>\n<column name='cRPMKR'>{ $rs/KNA1/ROW/RPMKR/text() }</column>\n<column name='cHZUOR'>{ $rs/KNA1/ROW/HZUOR/text() }</column>\n<column name='cAnnual'>{ $UMSA1 }{ '     ' }{ $rs/KNA1/ROW/UWAER/text() } in {$UMJAH }</column>\n<column name='cEmployees'>{ $JMZAH } in { $JMJAH }</column>\n<column name='cGFORM'>{ $rs/KNA1/ROW/GFORM/text() }</column>\n\n<column name='cAKONT'>{ $AKONT_trim }</column>\n<column name='cKNRZE'>{ $rs/KNB1/ROW/KNRZE/text() }</column>\n<column name='cBEGRU'>{ $rs/KNB1/ROW/BEGRU/text() }</column>\n<column name='cKey'>{ $rs/KNB1/ROW/ZUAWA/text() }{ '     ' }{ $TZUNT }</column>\n<column name='cBLNKZ'>{ $rs/KNB1/ROW/BLNKZ/text() }</column>\n<column name='cCash'>{ $rs/KNB1/ROW/FDGRV/text() }{ '      ' }{ $T035T }</column>\n<column name='cWBRSL'>{ $rs/KNB1/ROW/WBRSL/text() }</column>\n<column name='cVZSKZ'>{ $rs/KNB1/ROW/VZSKZ/text() }</column>\n<column name='cZINRT'>{ $rs/KNB1/ROW/ZINRT/text() }</column>\n<column name='cZINDT'>{ $ZINDT }</column>\n<column name='cDATLZ'>{ $DATLZ }</column>\n<column name='cALTKN'>{ $rs/KNB1/ROW/ALTKN/text() }</column>\n<column name='cEKVBD'>{ $rs/KNB1/ROW/EKVBD/text() }</column>\n<column name='cPERNR'>{ $PERNR }</column>\n\n<column name='cZTERM'>{ $rs/KNB1/ROW/ZTERM/text() }</column>\n<column name='cWAKON'>{ $rs/KNB1/ROW/WAKON/text() }</column>\n<column name='cKULTG'>{ $rs/KNB1/ROW/KULTG/text() }</column>\n<column name='cTOGRU'>{ $rs/KNB1/ROW/TOGRU/text() }</column>\n<column name='cURLID'>{ $rs/KNB1/ROW/URLID/text() }</column>\n<column name='cCESSION_KZ'>{ $rs/KNB1/ROW/CESSION_KZ/text() }</column>\n<column name='cXZVER'>{ $rs/KNB1/ROW/XZVER/text() }</column>\n<column name='cZWELS'>{ $rs/KNB1/ROW/ZWELS/text() }</column>\n<column name='cKNRZB'>{ $rs/KNB1/ROW/KNRZB/text() }</column>\n<column name='cLimit'>{ $WEBTR }{ '     ' }{ $WAERS }</column>\n<column name='cXPORE'>{ $rs/KNB1/ROW/XPORE/text() }</column>\n<column name='cXEDIP'>{ $rs/KNB1/ROW/CEDIP/text() }</column>\n<column name='cZAHLS'>{ $rs/KNB1/ROW/ZAHLS/text() }</column>\n<column name='cHBKID'>{ $rs/KNB1/ROW/HBKID/text() }</column>\n<column name='cZGRUP'>{ $rs/KNB1/ROW/ZGRUP/text() }</column>\n<column name='cREMIT'>{ $rs/KNB1/ROW/REMIT/text() }</column>\n<column name='cLOCKB'>{ $rs/KNB1/ROW/LOCKB/text() }</column>\n<column name='cVRSDG'>{ $rs/KNB1/ROW/VRSDG/text() }</column>\n<column name='cSREGL'>{ $rs/KNB1/ROW/SREGL/text() }</column>\n\n<column name='cVRSNR'>{ $rs/KNB1/ROW/VRSNR/text() }</column>\n<column name='cVRBKZ'>{ $rs/KNB1/ROW/VRBKZ/text() }</column>\n<column name='cAmount'>{ $VLIBB }{ '     ' }{ $WAERS }</column>\n<column name='cVERDT'>{ $rs/KNB1/ROW/VERDT/text() }</column>\n<column name='cVRSZL'>{ $rs/KNB1/ROW/VRSZL/text() }</column>\n<column name='cVRSPR'>{ $rs/KNB1/ROW/VRSPR/text() } %</column>\n\n<column name='cDistrict'>{ $rs/KNVV/ROW/BZIRK/text() }{ '     ' }{ $T171T }</column>\n<column name='cOffice'>{ $rs/KNVV/ROW/VKBUR/text() }{ '     '}{ $TVKBT }</column>\n<column name='cGroup'>{ $rs/KNVV/ROW/VKGRP/text() }{ '     ' }{ $TVGRT }</column>\n<column name='cCust'>{ $rs/KNVV/ROW/KDGRP/text() }{ '     ' }{ $T151T }</column>\n<column name='cKLABC'>{ $rs/KNVV/ROW/KLABS/text() }</column>\n<column name='cCurrency'>{ $rs/KNVV/ROW/WAERS/text() }{ '     ' }{ $TCURT }</column>\n<column name='cRDOFF'>{ $rs/KNVV/ROW/RDOF/text() }</column>\n<column name='cAWAHR'>{ $rs/KNVV/ROW/AWAHR/text() } %</column>\n<column name='cBEGRU'>{ $rs/KNVV/ROW/BEGRU/text() }</column>\n<column name='cVSORT'>{ $rs/KNVV/ROW/VSORT/text() }</column>\n<column name='cEIKTO'>{ $rs/KNVV/ROW/EIKTO/text() }</column>\n<column name='cMEGRU'>{ $rs/KNVV/ROW/MEGRU/text() }</column>\n<column name='cKURST'>{ $rs/KNVV/ROW/KURST/text() }</column>\n<column name='cPVKSM'>{ $rs/KNVV/ROW/PVKSM/text() }</column>\n<column name='cKONDA'>{ $rs/KNVV/ROW/KONDA/text() }</column>\n<column name='cCpp'>{ $rs/KNVV/ROW/KALKS/text() }{ '     ' }{ $TVKDT }</column>\n<column name='cPLTYP'>{ $rs/KNVV/ROW/PLTYP/text() }</column>\n<column name='cCsg'>{ $rs/KNVV/ROW/VERSG/text() }{ '     ' }{ $TVSDT }</column>\n<column name='cAGREL'>{ $rs/KNVV/ROW/AGREL/text() }</column>\n<column name='cNAME1'>{ $rs/KNVV/ROW/NAME1/text() }</column>\n<column name='cSTRAS'>{ $rs/KNVV/ROW/STRAS/text() }</column>\n<column name='cPOSHS'>{ $rs/KNVV/ROW/ADRNR/text() }</column>\n<column name='cPSTLZ'>{ $rs/KNVV/ROW/PSTLZ/text() }</column>\n<column name='cORT01'>{ $rs/KNVV/ROW/ORT01/text() }</column>\n\n<column name='cDelivery'>{ $rs/KNVV/ROW/LPRIO/text() }{ '     ' }{ $TPRIT }</column>\n<column name='cShipping'>{ $rs/KNVV/ROW/VSBED/text() }{ '     '}{ $TVSBT }</column>\n<column name='cVWERK'>{ $rs/KNVV/ROW/VWERK/text() }</column>\n<column name='cPODKZ'>{ $rs/KNVV/ROW/PODKZ/text() }</column>\n<column name='cPODTG'>{ $rs/KNVV/ROW/PODTG/text() }</column>\n<column name='cKZAZU'>{ $rs/KNVV/ROW/KZAZU/text() }</column>\n<column name='cPartial'>{ $rs/KNVV/ROW/KZTLF/text() }{ '     '}{ $TVKBT }</column>\n<column name='cANTLF'>{ $rs/KNVV/ROW/ANTLF/text() }</column>\n<column name='cUEBTK'>{ $rs/KNVV/ROW/UEBTK/text() }</column>\n<column name='cUNTTO'>{ $rs/KNVV/ROW/UNTTO/text() }</column>\n<column name='cUEBTO'>{ $rs/KNVV/ROW/UEBTO/text() }</column>\n<column name='cZone'>{ $rs/KNA1/ROW/LZONE/text() }{ '     '}{ $TZONT }</column>\n\n<column name='cMRNKZ'>{ $rs/KNVV/ROW/MRNKZ/text() }</column>\n<column name='cBOKRE'>{ $rs/KNVV/ROW/BOKRE/text() }</column>\n<column name='cPRFRE'>{ $rs/KNVV/ROW/PRFRE/text() }</column>\n<column name='cPERFK'>{ $rs/KNVV/ROW/PERFK/text() }{ '     '}{ $TFACT }</column>\n<column name='cPERRL'>{ $rs/KNVV/ROW/PERRL/text() }</column>\n<column name='cINCO1'>{ $rs/KNVV/ROW/INCO1/text() }{ '     '}{ $rs/KNVV/ROW/INCO2/text() }</column>\n<column name='cZTERM2'>{ $rs/KNVV/ROW/ZTERM/text() }{ '     '}{ $TVZBT }</column>\n<column name='cKABSS'>{ $rs/KNVV/ROW/KABSS/text() }</column>\n<column name='cKKBER'>{ $rs/KNVV/ROW/KKBER/text() }</column>\n<column name='cKTGRD'>{ $rs/KNVV/ROW/KTGRD/text() }{ '     '}{ $TVKTT }</column>\n</row>\n\nreturn local:getResultsPage($rows, $page, $size)",
  "moduleNamespaces" : [ "urn:x-sig:sias:util:fn" ],
  "searchName" : "XD03 - Display Customer",
  "compositionName" : "XD03"
}