{
  "createdBy" : "admin@sigma-sbs.com",
  "createdDate" : null,
  "lastModifiedBy" : "admin@sigma-sbs.com",
  "lastModifiedDate" : null,
  "name" : "bd5134c7-524e-49d5-8c7f-b9bd6ee94a7f",
  "query" : "declare namespace ia = \"urn:x-emc:ia:schema:fn\";\ndeclare namespace table=\"urn:x-emc:ia:schema:table\";\nimport module namespace sias=\"urn:x-sig:sias:util:fn\";\n\ndeclare variable $page external;\ndeclare variable $size external;\n\n(: Our External Search variable matching the SAP Fieldname :)\ndeclare variable $sMBLNR external;\ndeclare variable $sMJAHR external;\n\ndeclare function local:getResultsPage($rows, $page, $size) {\n  let $offset := $page * $size\n  let $total := count($rows)\n  return <results total=\"{ $total }\"> {\n    for $row in subsequence($rows, $offset + 1, $size)\n      return $row\n  } </results>\n\n};\ndeclare function local:get_wever($WEVER) {\n\n\tswitch ($WEVER)\n    case \"1\" return \"Individual Slip\"\n    case \"2\" return \"Individual slip with inspection text\"\n    case \"3\" return \"Collective slip\"\n    default return \"None\"\n\n};\n\ndeclare function local:addClause($whereClause as xs:string, $var as xs:string*, $expr as xs:string) as xs:string\n{\nif (empty($var) or $var = \"\")\nthen $whereClause\nelse if ($whereClause = \"\") then $expr else concat($whereClause, \" and \", $expr)\n};\n\n(: Build a conditional Where clause :)\n\nlet $whereClause := local:addClause(\"\", $sMBLNR, concat(\"contains($mseg/MBLNR, &apos;\", $sMBLNR, \"&apos;)\" ))\nlet $whereClause := local:addClause($whereClause, $sMJAHR, concat(\"contains($mseg/MJAHR, &apos;\", $sMJAHR, \"&apos;)\"))\nlet $whereClause := if ($whereClause != \"\") then concat(\"where \", $whereClause) else $whereClause\n\n(: Search the data within the Table with a join on Info Record [INFNR] :)\n(: Select * from BKPF where BELNR = \"\" and BUKRS = \"\" and GJAHR = \"\" :)\n\nlet $query-str := concat(\"for $mkpf in /SAP/MKPF/ROW , $mseg in /SAP/MSEG/ROW[MBLNR = $mkpf/MBLNR and MJAHR=$mkpf/MJAHR], $makt in /SAP/MAKT/ROW[MATNR = $mseg/MATNR and SPRAS='EN'] \" , $whereClause, \" return<RS><MKPF>{ $mkpf }</MKPF><MSEG>{ $mseg }</MSEG><MAKT>{ $makt }</MAKT></RS>\")\n\nlet $main-query := xhive:evaluate($query-str)\n\nlet $rows := \n               for $rs in $main-query \n               \nlet $LTEXT := sias:get_t158w($rs/MKPF/ROW/VGART/text())\nlet $WEVER := local:get_wever($rs/MKPF/ROW/WEVER/text())\nlet $ZEILE := sias:trimzero($rs/MSEG/ROW/ZEILE/text())\nlet $MATNR := $rs/MSEG/ROW/MATNR/text()\nlet $SAKTO := sias:trimzero($rs/MSEG/ROW/SAKTO/text())\nlet $ERFME := sias:get_t006a($rs/MSEG/ROW/ERFME/text())\nlet $BLDAT := sias:showdate($rs/MKPF/ROW/BLDAT/text())\nlet $BUDAT := sias:showdate($rs/MKPF/ROW/BUDAT/text())\nlet $CPUDT := sias:showdate($rs/MKPF/ROW/CPUDT/text())\nlet $CPUTM := sias:showtime($rs/MKPF/ROW/CPUTM/text())\nlet $ERFMG := sias:currency($rs/MSEG/ROW/ERFMG/text(), \"\")\nlet $XBLNR := $rs/MKPF/ROW/XBLNR/text()\n    \nreturn\n<row id='{string($rs/MSEG/ROW/@table:id)}'>\n<column name='cZEILE'>{ $ZEILE }</column>\n<column name='cBWART'>{ $rs/MSEG/ROW/BWART/text() }</column>\n<column name='cMATNR'>{ $MATNR }</column>\n<column name='cERFMG'>{ $ERFMG }</column>\n<column name='cERFME'>{ $ERFME }</column>\n<column name='cQuantity'>{ $ERFMG } { ' ' } { $ERFME }</column>\n<column name='cLGORT'>{ $rs/MSEG/ROW/LGORT/text() }</column>\n<column name='cWERKS'>{ $rs/MSEG/ROW/WERKS/text() }</column>\n<column name='cMAKTX'>{ $rs/MAKT/ROW/MAKTX/text() }</column>\n<column name='cRSNUM'>{ $rs/MSEG/ROW/RSNUM/text() } { ' ' } { $rs/MSEG/ROW/RSPOS/text() } { ' ' } { $rs/MSEG/ROW/KZEAR/text() }</column>\n<column name='cSAKTO'>{ $SAKTO }</column>\n<column name='cGSBER'>{ $rs/MSEG/ROW/GSBER/text() }</column>\n<column name='cKOSTL'>{ $rs/MSEG/ROW/KOSTL/text() }</column>\n<column name='cAUFNR'>{ $rs/MSEG/ROW/AUFNR/text() }</column>\n<column name='cUMCHA'>{ $rs/MSEG/ROW/UMCHA/text() }</column>\n<column name='cLGORT'>{ $rs/MSEG/ROW/LGORT/text() }</column>\n<column name='cMANUFDATE'>{ $rs/MSEG/ROW/HSDAT/text() } / { $rs/MSEG/ROW/VFDAT/text() }</column>\n<column name='cCHARG'>{ $rs/MSEG/ROW/CHARG/text() }</column>\n<column name='cBLDAT'>{ $BLDAT }</column>\n<column name='cBUDAT'>{ $BUDAT }</column>\n<column name='cMJAHR'>{ $rs/MKPF/ROW/MJAHR/text() }</column>\n<column name='cCPUTM'>{ $CPUTM }</column>\n<column name='cCPUDT'>{ $CPUDT }</column>\n<column name='cVGART'>{ $rs/MKPF/ROW/VGART/text() } { ' ' } { $LTEXT }</column>\n<column name='cUSNAM'>{ $rs/MKPF/ROW/USNAM/text() }</column>\n<column name='cWEVER'>{ $WEVER }</column>\n<column name='cXBLNR'>{ $XBLNR }</column>\n</row>\n\nreturn local:getResultsPage($rows, $page, $size)\n",
  "moduleNamespaces" : [ "urn:x-sig:sias:util:fn" ],
  "searchName" : "MB03-Display material document",
  "compositionName" : "MB03"
}