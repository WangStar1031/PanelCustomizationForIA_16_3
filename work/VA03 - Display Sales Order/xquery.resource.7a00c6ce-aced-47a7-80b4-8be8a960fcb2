{
  "createdBy" : "admin@sigma-sbs.com",
  "createdDate" : null,
  "lastModifiedBy" : "admin@sigma-sbs.com",
  "lastModifiedDate" : null,
  "name" : "8cf9b0be-0e75-4cf3-8ebd-fbe7c867146c",
  "query" : "declare namespace ia = \"urn:x-emc:ia:schema:fn\";\ndeclare namespace table=\"urn:x-emc:ia:schema:table\";\n\nimport module namespace sias=\"urn:x-sig:sias:util:fn\";\n\ndeclare variable $page external;\ndeclare variable $size external;\n\ndeclare variable $sVBELN external;\n\ndeclare function local:getResultsPage($rows, $page, $size) {\n  let $offset := $page * $size\n  let $total := count($rows)\n  return <results total=\"{ $total }\"> {\n    for $row in subsequence($rows, $offset + 1, $size)\n      return $row\n  } </results>\n};\n\ndeclare function local:get_t040s($MANSP)\n{\n\tswitch($MANSP)\n    case \"A\" return \"Manual block due to a telephone payment advice\"\n    case \"B\" return \"Manual block due to a complaints against vendor\"\n    case \"D\" return \"Disputed item\"\n    case \"H\" return \"Block reason H\"\n    case \"R\" return \"Blocked by invoice verification\"\n    default return \"Freed for dunning\"\n};\n\ndeclare function local:get_uvall($UVALL)\n{\n\tswitch ($UVALL)\n    case \"A\" return \"Not yet processed\"\n    case \"B\" return \"Partially processed\"\n    case \"C\" return \"Completely processed\"\n    default return \"Not Relevant\"\n};\n\ndeclare function local:get_uvvlk($UVVLK)\n{\n\tswitch ($UVVLK)\n    case \"A\" return \"Not yet processed\"\n    case \"B\" return \"Partially processed\"\n    case \"C\" return \"Completely processed\"\n    default return \"Not Relevant\"\n};\n\ndeclare function local:get_uvfak($UVFAK)\n{\n\tswitch ($UVFAK)\n    case \"A\" return \"Not yet processed\"\n    case \"B\" return \"Partially processed\"\n    case \"C\" return \"Completely processed\"\n    default return \"Not Relevant\"\n};\n    \ndeclare function local:get_partner($vbeln, $parvw)\n{\n    for $vbpa in /SAP/VBPA/ROW[VBELN=$vbeln and PARVW=$parvw]\n    return $vbpa/KUNNR/text()\n};\n\ndeclare function local:get_kna1($kunnr)\n{\n   for $kna1 in /SAP/KNA1/ROW[KUNNR=$kunnr]\n   return concat($kna1/NAME1/text(),'/',$kna1/STRAS/text(),'/',$kna1/LAND1/text(),' ',$kna1/PSLTX/text(),'/',$kna1/ORT01/text())\n};\n\ndeclare function local:get_vbep($VBELN)\n{\n\tfor $vbep in /SAP/VBEP/ROW\n\twhere $vbep/VBELN = $VBELN\n    return \n    <RS>\n    <VBEP>{ $vbep }</VBEP>\n    </RS>\n};\n\ndeclare function local:addClause($whereClause as xs:string, $var as xs:string*, $expr as xs:string) as xs:string\n{\nif (empty($var) or $var = \"\")\nthen $whereClause\nelse if ($whereClause = \"\") then $expr else concat($whereClause, \" and \", $expr)\n};\n\nlet $whereClause := local:addClause(\"\", $sVBELN, concat(\"contains($vbak/VBELN, &apos;\", $sVBELN, \"&apos;)\" ))\nlet $whereClause := if ($whereClause != \"\") then concat(\"where \", $whereClause) else $whereClause\n\nlet $query-str := concat(\"for $vbak in /SAP/VBAK/ROW, $vbap in /SAP/VBAP/ROW[VBELN = $vbak/VBELN], $vbkd in /SAP/VBKD/ROW[VBELN = $vbak/VBELN], $vbup in /SAP/VBUP/ROW[VBELN = $vbap/VBELN and POSNR=$vbap/POSNR] \", $whereClause, \"and fn:exists($vbkd/POSNR) return <RS> <VBAK>{ $vbak }</VBAK><VBAP>{ $vbap }</VBAP><VBKD>{ $vbkd }</VBKD><VBUP>{ $vbup }</VBUP></RS>\")\n\nlet $main-query := xhive:evaluate($query-str)\n \nlet $rows :=       \n               for $rs in $main-query\n               \t let $vbep := local:get_vbep($sVBELN)\n                 let $SOLDTO := local:get_partner($rs/VBAK/ROW/VBELN/text(),'AG')\n                 let $SHIPTO := local:get_partner($rs/VBAK/ROW/VBELN/text(),'WE')\n                 let $PAYETO := local:get_partner($rs/VBAK/ROW/VBELN/text(),'RG')\n                 let $KUNAG := local:get_kna1($SOLDTO)\n                 let $KUNWE := local:get_kna1($SHIPTO)\n                 let $KUNRG := local:get_kna1($PAYETO)\n                 let $AUDAT := sias:showdate($rs/VBAK/ROW/AUDAT/text())\n                 let $LAND2 := sias:get_t001($rs/VBAK/ROW/BUKRS/text(), \"LAND1\")\n                 let $DELCO := sias:get_tvdct($rs/VBKD/ROW/DELCO/text())\n                 let $EXART := sias:get_t605t($LAND2,$rs/VBAP/ROW/EXART/text())\n                 let $WERKS := sias:get_t001w($rs/VBAP/ROW/WERKS/text())\n                 let $ABSSC := sias:get_t691n($rs/VBKD/ROW/ABSSC/text())\n                 let $OVER := sias:get_tvbst(\"VBUP\", \"GBSTA\", $rs/VBUP/ROW/GBSTA/text())\n                 let $DELIV := sias:get_tvbst(\"VBUP\",\"LFSTA\", $rs/VBUP/ROW/LFSTA/text())\n                 let $UVALL := local:get_uvall($rs/VBUP/ROW/UVALL/text())\n                 let $UVVLK := local:get_uvvlk($rs/VBUP/ROW/UVVLK/text())\n                 let $UVFAK := local:get_uvfak($rs/VBUP/ROW/UVFAK/text())\n                 let $ABGRU := sias:get_tvagt($rs/VBAP/ROW/ABGRU/text())\n                 let $ZTERM := sias:get_tvzbt($rs/VBKD/ROW/ZTERM/text())\n                 let $MANSP := local:get_t040s($rs/VBKD/ROW/MANSP/text())\n                 let $POSNR := sias:trimzero($rs/VBAP/ROW/POSNR/text())\n                 let $EDATU := sias:showdate($vbep/VBEP/ROW/EDATU/text())\n                 let $PRSDT := sias:showdate($rs/VBKD/ROW/PRSDT/text())\n                 let $MATKL := sias:trimzero($rs/VBAP/ROW/MATKL/text())\n                 let $SPART := sias:trimzero($rs/VBAP/ROW/SPART/text())\n                 let $ROUTE := sias:trimzero($rs/VBAP/ROW/ROUTE/text())\n                 let $ZTERM := sias:trimzero($rs/VBKD/ROW/ZTERM/text())\n                 let $FKDAT := sias:showdate($rs/VBKD/ROW/FKDAT/text())\n                 let $ABSSC1 := sias:trimzero($rs/VBKD/ROW/ABSSC/text())\n                 let $PRCTR := sias:trimzero($rs/VBAP/ROW/PRCTR/text())\n               \nreturn\n<row id='{string($rs/VBAK/ROW/@table:id)}'>\n<column name='cVBELN'>{ $rs/VBAK/ROW/VBELN/text() }</column>\n<column name='kAUDAT'>{ $AUDAT }</column>\n<column name='kNETWR'>{ $rs/VBAK/ROW/NETWR/text() } {' '} { $rs/VBAK/ROW/WAERK/text() }</column>\n<column name='cSOLDTO'>{ $SOLDTO }</column>\n\n<column name='cPOSNR'>{ $POSNR }</column>\n<column name='cMATNR'>{ $rs/VBAP/ROW/MATNR/text() }</column>\n<column name='cARKTX'>{ $rs/VBAP/ROW/ARKTX/text() }</column>\n<column name='cNETPR'>{ $rs/VBAP/ROW/NETPR/text() }</column>\n<column name='cKWMENG'>{ $rs/VBAP/ROW/KWMENG/text() }</column>\n<column name='cKMEIN'>{ $rs/VBAP/ROW/KMEIN/text() }</column>\n<column name='cNETWR'>{ $rs/VBAP/ROW/NETWR/text() }</column>\n\n<column name='cKWMENG2'>{ $rs/VBAP/ROW/KWMENG/text() } { ' ' } { $rs/VBAP/ROW/VRKME/text() } { ' ' } { $rs/VBAP/ROW/UMVKN/text() } { ' ' } { $rs/VBAP/ROW/VRKME/text() } { '<->' } { $rs/VBAP/ROW/UMVKN/text() } { ' ' } { $rs/VBEP/ROW/MEINS/text() }</column>\n<column name='cEDATU'>{ $EDATU }</column>\n<column name='cDELCO'>{ $DELCO }</column>\n<column name='cNETWR'>{ $rs/VBAP/ROW/NETWR/text() } { ' ' } { $rs/VBAK/ROW/WAERK/text() }</column>\n<column name='cKURSK'>{ $rs/VBKD/ROW/KURSK/text() }</column>\n<column name='cPRSDT'>{ $PRSDT }</column>\n<column name='cMATWA'>{ $rs/VBAP/ROW/MATWA/text() }</column>\n<column name='cEAN11'>{ $rs/VBAP/ROW/EAN11/text() }</column>\n<column name='cSERNR'>{ $rs/VBAP/ROW/SERNR/text() }</column>\n<column name='cEXART'>{ $rs/VBAP/ROW/EXART/text() } { ' ' } { $EXART }</column>\n\n\n<column name='cPMATN'>{ $rs/VBAP/ROW/PMATN/text() }</column>\n<column name='cPRODH'>{ $rs/VBAP/ROW/PRODH/text() }</column>\n<column name='cMATKL'>{ $rs/VBAP/ROW/MATKL/text() }</column>\n<column name='cWGRU1'>{ $rs/VBAP/ROW/WGRU1/text() }</column>\n<column name='cWGRU2'>{ $rs/VBAP/ROW/WGRU2/text() }</column>\n<column name='cSPART'>{ $rs/VBAP/ROW/SPART/text() }</column>\n<column name='cKONDM'>{ $rs/VBAP/ROW/KONDM/text() }</column>\n<column name='cKDGRP'>{ $rs/VBKD/ROW/KDGRP/text() }</column>\n<column name='cKONDA'>{ $rs/VBKD/ROW/KONDA/text() }</column>\n<column name='cPLTYP'>{ $rs/VBKD/ROW/PLTYP/text() }</column>\n<column name='cBZIRK'>{ $rs/VBKD/ROW/BZIRK/text() }</column>\n\n<column name='cSHIP'>{ $SHIPTO } {' '} { $KUNWE }</column>\n<column name='cEMPST'>{ $rs/VBKD/ROW/EMPST/text() }</column>\n<column name='cABTNR'>{ $rs/VBKD/ROW/ABTNR/text() }</column>\n<column name='cLPRIO'>{ $rs/VBAP/ROW/LPRIO/text() }</column>\n<column name='cWERKS'>{ $rs/VBAP/ROW/WERKS/text() } { ' ' } { $WERKS }</column>\n<column name='cLGORT'>{ $rs/VBAP/ROW/LGORT/text() }</column>\n<column name='cVSTEL'>{ $rs/VBAP/ROW/VSTEL/text() }</column>\n<column name='cKZTLF'>{ $rs/VBAP/ROW/KZTLF/text() }</column>\n<column name='cROUTE'>{ $ROUTE }</column>\n<column name='cANTLF'>{ $rs/VBAP/ROW/ANTLF/text() }</column>\n<column name='cMFRGR'>{ $rs/VBAP/ROW/MFRGR/text() }</column>\n<column name='cKZAZU'>{ $rs/VBKD/ROW/KZAZU/text() }</column>\n<column name='cTRATY'>{ $rs/VBKD/ROW/TRATY/text() }</column>\n<column name='cVSART'>{ $rs/VBKD/ROW/VSART/text() }</column>\n<column name='cTRMTYP'>{ $rs/VBKD/ROW/TRMTYP/text() }</column>\n<column name='cNTGEW'>{ $rs/VBAP/ROW/NTGEW/text() } { ' ' } { $rs/VBAP/ROW/GEWEI/text() }</column>\n<column name='cBRGEW'>{ $rs/VBAP/ROW/BRGEW/text() }</column>\n<column name='cVOLUM'>{ $rs/VBAP/ROW/VOLUM/text() }</column>\n<column name='cUEBTO'>{ $rs/VBAP/ROW/UEBTO/text() } { ' % ' }</column>\n<column name='cUNTTO'>{ $rs/VBAP/ROW/UNTTO/text() } { ' % ' }</column>\n<column name='cVEBTK'>{ $rs/VBAP/ROW/VEBTK/text() }</column>\n\n<column name='cPAYER'>{ $PAYETO } {' '} { $KUNRG }</column>\n<column name='cINCO1'>{ $rs/VBKD/ROW/INCO1/text() } { ' ' } { $rs/VBKD/ROW/INCO2/text() }</column>\n<column name='cVALDT'>{ $rs/VBKD/ROW/VALDT/text() }</column>\n<column name='cZTERM'>{ $ZTERM } { ' ' } { $ZTERM }</column>\n<column name='cVALTG'>{ $rs/VBKD/ROW/VALTG/text() }</column>\n<column name='cFAKSP'>{ $rs/VBAP/ROW/FAKSP/text() }</column>\n<column name='cPERFK'>{ $rs/VBKD/ROW/PERFK/text() }</column>\n<column name='cFKDAT'>{ $FKDAT }</column>\n<column name='cFBUDA'>{ $rs/VBKD/ROW/FBUDA/text() }</column>\n<column name='cTAXM1'>{ $rs/VBAP/ROW/TAXM1/text() }</column>\n<column name='cMRNKZ'>{ $rs/VBKD/ROW/MRNKZ/text() }</column>\n<column name='cKTGRM'>{ $rs/VBAP/ROW/KTGRM/text() }</column>\n<column name='cZLSCH'>{ $rs/VBKD/ROW/ZLSCH/text() }</column>\n<column name='cPOPER'>{ $rs/VBKD/ROW/POPER/text() } { ' ' } { $rs/VBKD/ROW/GJAHR/text() }</column>\n<column name='cKURRF'>{ $rs/VBKD/ROW/KURRF/text() }</column>\n<column name='cMSCHL'>{ $rs/VBKD/ROW/MSCHL/text() }</column>\n<column name='cMANSP'>{ $MANSP }</column>\n<column name='cRRREL'>{ $rs/VBKD/ROW/RRREL/text() }</column>\n<column name='cREVSP'>{ $rs/VBKD/ROW/REVSP/text() }</column>\n<column name='cACDATV'>{ $rs/VBKD/ROW/ACDATV/text() }</column>\n<column name='cREVEVTYP'>{ $rs/VBKD/ROW/REVEVTYP/text() }</column>\n<column name='cABSSC'>{ $ABSSC1 } { ' ' } { $ABSSC }</column>\n<column name='cABFOR'>{ $rs/VBAP/ROW/ABFOR/text() }</column>\n<column name='cLCNUM'>{ $rs/VBKD/ROW/LCNUM/text() }</column>\n\n<column name='cGSBER'>{ $rs/VBAP/ROW/GSBER/text() }</column>\n<column name='cAUFNR'>{ $rs/VBAP/ROW/AUFNR/text() }</column>\n<column name='cPRCTR'>{ $PRCTR }</column>\n<column name='cPS_PSP_PNR'>{ $rs/VBAP/ROW/PS_PSP_PNR/text() }</column>\n<column name='cKALSM_K'>{ $rs/VBAP/ROW/KALSM_K/text() }</column>\n<column name='cZSCHL_K'>{ $rs/VBAP/ROW/ZSCHL_K/text() }</column>\n\n<column name='cBSTKD'>{ $rs/VBKD/ROW/BSTKD/text() }</column>\n<column name='cBSTDK'>{ $rs/VBKD/ROW/BSTDK/text() }</column>\n<column name='cBSARK'>{ $rs/VBKD/ROW/BSARK/text() }</column>\n<column name='cPOSEX'>{ $rs/VBAP/ROW/POSEX/text() }</column>\n<column name='cIHREZ'>{ $rs/VBAP/ROW/IHREZ/text() }</column>\n<column name='cKDMAT'>{ $rs/VBAP/ROW/KDMAT/text() }</column>\n<column name='cIUID_RELEVANT'>{ $rs/VBAP/ROW/IUID_RELEVANT/text() }</column>\n\n<column name='cBSTKD_E'>{ $rs/VBAP/ROW/BSTKD_E/text() }</column>\n<column name='cBSTDK_E'>{ $rs/VBAP/ROW/BSTDK_E/text() }</column>\n<column name='cBSARK_E'>{ $rs/VBAP/ROW/BSARK_E/text() }</column>\n<column name='cPOSEX_E'>{ $rs/VBAP/ROW/POSEX_E/text() }</column>\n<column name='cIHREZ_E'>{ $rs/VBAP/ROW/IHREZ_E/text() }</column>\n\n<column name='cOVER'>{ $OVER }</column>\n<column name='cABGRU'>{ $ABGRU }</column>\n<column name='cDELIV'>{ $DELIV }</column>\n<column name='cUVALL'>{ $UVALL }</column>\n<column name='cUVVLK'>{ $UVVLK }</column>\n<column name='cUVFAK'>{ $UVFAK }</column>\n\n\n</row>\n\nreturn local:getResultsPage($rows, $page, $size)\n",
  "moduleNamespaces" : [ "urn:x-sig:sias:util:fn" ],
  "searchName" : "VA03 - Item Detail",
  "compositionName" : "VA03 - Item Data"
}