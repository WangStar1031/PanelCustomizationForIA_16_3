{
  "createdBy" : "admin@sigma-sbs.com",
  "createdDate" : null,
  "lastModifiedBy" : "admin@sigma-sbs.com",
  "lastModifiedDate" : null,
  "name" : "1799d07f-b7d8-466b-b3f7-44acd3fc5021",
  "query" : "declare namespace ia = \"urn:x-emc:ia:schema:fn\";\ndeclare namespace table=\"urn:x-emc:ia:schema:table\";\n\nimport module namespace sias=\"urn:x-sig:sias:util:fn\";\n\ndeclare variable $page external;\ndeclare variable $size external;\n\ndeclare variable $sVBELN external;\n\ndeclare function local:getResultsPage($rows, $page, $size) {\n  let $offset := $page * $size\n  let $total := count($rows)\n  return <results total=\"{ $total }\"> {\n    for $row in subsequence($rows, $offset + 1, $size)\n      return $row\n  } </results>\n};\n\ndeclare function local:addClause($whereClause as xs:string, $var as xs:string*, $expr as xs:string) as xs:string\n{\nif (empty($var) or $var = \"\")\nthen $whereClause\nelse if ($whereClause = \"\") then $expr else concat($whereClause, \" and \", $expr)\n};\n\ndeclare function local:get_mansp($MANSP)\n{\n\tswitch ($MANSP)\n    case \"A\" return \"Manual block due to a telephone payment advice\"\n    case \"B\" return \"Manual block due to a complaints against vendor\"\n    case \"D\" return \"Disputed item\"\n    case \"H\" return \"Block Reason H\"\n    case \"R\" return \"Blocked by invoice verification\" \n    default return \"Freed for Dunning\"\n};\n\ndeclare function local:get_partner($vbeln, $parvw)\n{\n    for $vbpa in /SAP/VBPA/ROW[VBELN=$vbeln and PARVW=$parvw]\n    return $vbpa/KUNNR/text()\n};\n\ndeclare function local:get_kna1($kunnr)\n{\n   for $kna1 in /SAP/KNA1/ROW[KUNNR=$kunnr]\n   return concat($kna1/NAME1/text(),'/',$kna1/STRAS/text(),'/',$kna1/LAND1/text(),' ',$kna1/PSLTX/text(),'/',$kna1/ORT01/text())\n};\n\n\nlet $whereClause := local:addClause(\"\", $sVBELN, concat(\"contains($vbak/VBELN, &apos;\", $sVBELN, \"&apos;)\" )) \nlet $whereClause := if ($whereClause != \"\") then concat(\"where \", $whereClause) else $whereClause\n\nlet $query-str := concat(\"for $vbak in /SAP/VBAK/ROW, $vbkd in /SAP/VBKD/ROW[VBELN = $vbak/VBELN]\", $whereClause, \"and fn:exists($vbkd/POSNR) return <RS><VBAK>{ $vbak }</VBAK><VBKD>{ $vbkd }</VBKD></RS>\")\n\nlet $main-query := xhive:evaluate($query-str)\n\nlet $rows := \n                for $rs in $main-query\n                let $SOLDTO := local:get_partner($rs/VBAK/ROW/VBELN/text(),'SP')\n                let $SHIPTO := local:get_partner($rs/VBAK/ROW/VBELN/text(),'SH')\n                let $KUNAG := local:get_kna1($SOLDTO)\n                let $KUNWE := local:get_kna1($SHIPTO)\n                let $LAND2 := sias:get_t001($rs/VBAK/ROW/BUKRS/text(), \"LAND1\")\n                let $ZTERM := sias:get_tvzbt($rs/VBKD/ROW/ZTERM/text())\n                let $AUGRU := sias:get_tvaut($rs/VBAK/ROW/AUGRU/text())\n                let $ABTNR := sias:get_tsabt($rs/VBKD/ROW/ABTNR/text())\n                let $LIFSP := sias:get_tvlst($rs/VBAK/ROW/LIFSP/text())\n                let $VSBED := sias:get_tvsbt($rs/VBAK/ROW/VSBED/text())\n                let $TRATY := sias:get_tvtyt($rs/VBKD/ROW/TRATY/text())\n                let $VSART := sias:get_t173t($rs/VBKD/ROW/VSART/text())\n                let $SDABW := sias:get_tvsakt($rs/VBKD/ROW/SDABW/text())\n                let $AUART := sias:get_tvakt($rs/VBAK/ROW/AUART/text())\n                let $VKORG := sias:get_tvkot($rs/VBAK/ROW/VKORG/text())\n                let $VTWEG := sias:get_tvtwt($rs/VBAK/ROW/VTWEG/text())\n                let $SPART := sias:get_tspat($rs/VBAK/ROW/SPART/text())\n                let $VKBUR := sias:get_tvkbt($rs/VBAK/ROW/VKBUR/text())\n                let $DELCO := sias:get_tvdct($rs/VBKD/ROW/DELCO/text())\n                let $KVEWE := sias:get_t683u('A', 'V', $rs/VBAK/ROW/KALSM/text()) \n                let $KDGRP := sias:get_t151t($rs/VBKD/ROW/KDGRP/text())\n                let $PLTYP := sias:get_t189t($rs/VBKD/ROW/PLTYP/text())\n                let $ABRVW := sias:get_tvlvt($rs/VBAP/ROW/ABRVW/text())\n              \tlet $KONDA := sias:get_t188t($rs/VBKD/ROW/KONDA/text())\n                let $BZIRK := sias:get_t171t($rs/VBKD/ROW/BZIRK/text())\n                let $ZTERM := sias:get_tvzbt($rs/VBKD/ROW/ZTERM/text())\n                let $IDENT := sias:get_tfact($rs/VBKD/ROW/IDENT/text())\n                let $BUKRS_VF := sias:get_t001($rs/VBAK/ROW/BUKRS_VF/text(), \"BUTXT\")\n                let\t$ABSSC := sias:get_t691n($rs/VBKD/ROW/ABSSC/text())\n                let $KTGRD := sias:get_tvktt($rs/VBKD/ROW/KTGRD/text())\n                let $LAND1 := sias:get_t042z($LAND2, $rs/VBKD/ROW/ZLSCH/text()) \n                let $MSCHL := sias:get_t040a($rs/VBKD/ROW/MSCHL/text())\n                let $MANSP := local:get_mansp($rs/VBKD/ROW/MANSP/text())\n                let $BSTDK := sias:showdate($rs/VBKD/ROW/BSTDK/text())\n\t\t\t\tlet $PRSDT := sias:showdate($rs/VBKD/ROW/PRSDT/text())\n                let $AUDAT := sias:showdate($rs/VBAK/ROW/AUDAT/text())\n                let $ERDAT := sias:showdate($rs/VBAK/ROW/ERDAT/text())\n                let $VALDT := sias:showdate($rs/VBKD/ROW/VALDT/text())\n                let $FKDAT := sias:showdate($rs/VBKD/ROW/FKDAT/text())\n                let $ZTERM1 := sias:trimzero($rs/VBKD/ROW/ZTERM/text())\n                let $VBELN := sias:trimzero($rs/VBAK/ROW/VBELN/text())\n                \n                return\n<row id='{string($rs/VBAK/ROW/@table:id)}'> \n<column name='cVBELN'>{ $VBELN }</column> \n<column name='cNETWR'>{ $rs/VBAK/ROW/NETWR/text() } { ' ' } { $rs/VBAK/ROW/WAERK/text() }</column>\n<column name='cSOLDTO'>{ $SOLDTO }</column>\n<column name='cKUNNR'>{ $SOLDTO } {' '} { $KUNAG } </column>\n<column name='cKUNNR2'>{ $SHIPTO } {' '} { $KUNWE }</column>\n<column name='cBSTKD'>{ $rs/VBKD/ROW/BSTKD/text() }</column>\n<column name='cBSTDK'>{ $BSTDK }</column>\n<column name='cAUTLF'>{ $rs/VBAK/ROW/AUTLF/text() }</column>\n<column name='cPRSDT'>{ $PRSDT }</column>\n<column name='cCCNUM'>{ $rs/FPLTC/ROW/CCNUM/text() }</column>\n<column name='cDATBI'>{ $rs/FPLTC/ROW/DATBI/text() }</column>\n<column name='cZTERM'>{ $ZTERM1 } { ' ' } { $ZTERM }</column>\n<column name='cINCO1'>{ $rs/VBKD/ROW/INCO1/text() } { ' '} {$rs/VBKD/ROW/INCO2/text() }</column>\n<column name='cAUGRU'>{ $AUGRU }</column>\n \n<column name='cABTNR'>{ $rs/VBKD/ROW/ABTNR/text() } { ' ' } { $ABTNR }</column>\n<column name='cLIFSP'>{ $LIFSP }</column>\n<column name='cAUTLF'>{ $rs/VBAK/ROW/AUTLF/text() }</column>\n<column name='cVSBED'>{ $VSBED }</column>\n<column name='cKZAZU'>{ $rs/VBKD/ROW/KZAZU/text() }</column>\n<column name='cPROLI'>{ $rs/VBAK/ROW/PROLI/text() }</column>\n<column name='cCONT_DG'>{ $rs/VBAK/ROW/CONT_DG/text() }</column>\n<column name='cTRATY'>{ $rs/VBKD/ROW/TRATY/text() } { ' ' } { $TRATY }</column>\n<column name='cVSART'>{ $rs/VBKD/ROW/VSART/text() } { ' ' } { $VSART }</column>\n<column name='cTRMTYP'>{ $rs/VBKD/ROW/TRMTYP/text() }</column>\n<column name='cSDABW'>{ $rs/VBKD/ROW/SDABW/text() } { ' ' } { $SDABW }</column>\n<column name='cPODKZ'>{ $rs/VBKD/ROW/PODKZ/text() }</column>\n\n<column name='cAUART'>{ $rs/VBAK/ROW/AUART/text() } { ' ' } { $AUART }</column>\n<column name='cAUDAT'>{ $AUDAT }</column>\n<column name='cVKORG'>{ $rs/VBAK/ROW/VKORG/text() } { ' ' } { $rs/VBAK/ROW/VTWEG/text() } { ' ' } { $rs/VBAK/ROW/SPART/text() } { ' ' } { $VKORG } { ' ' } { $VTWEG } { ' ' } { $SPART }</column>\n<column name='cVKBUR'>{ $rs/VBAK/ROW/VKBUR/text() } { ' ' } { $VKBUR }</column>\n<column name='cERNAM'>{ $rs/VBAK/ROW/ERNAM/text() }</column>\n<column name='cVKGRP'>{ $rs/VBAK/ROW/VKGRP/text() }</column>\n<column name='cERDAT'>{ $ERDAT }</column>\n<column name='cVSNMR_V'>{ $rs/VBAK/ROW/VSNMR_V/text() }</column>\n<column name='cGWLDT'>{ $rs/VBAK/ROW/GWLDT/text() }</column>\n<column name='cDELCO'>{ $DELCO }</column>\n\n<column name='cWAERK'>{ $rs/VBAK/ROW/WAERK/text() } / { $rs/VBKD/ROW/KURSK/text() }</column>\n<column name='cPRSDT'>{ $PRSDT }</column>\n<column name='cKALSM'>{ $rs/VBAK/ROW/KALSM/text() } { ' ' } { $KVEWE }</column>\n<column name='cKDGRP'>{ $KDGRP }</column>\n<column name='cPLTYP'>{ $PLTYP }</column>\n<column name='cABRVW'>{ $ABRVW }</column>\n<column name='cKONDA'>{ $KONDA }</column>\n<column name='cKALSM'>{ $rs/VBAK/ROW/KALSM/text() }</column>\n<column name='cBZIRK'>{ $rs/VBKD/ROW/BZIRK/text() } { ' ' } { $BZIRK } </column>\n\n<column name='cPAYER'>{ $SOLDTO } {' '} { $KUNAG }</column>\n<column name='cINCO1'>{ $rs/VBKD/ROW/INCO1/text() } { ' ' } { $rs/VBKD/ROW/INCO2/text() }</column>\n<column name='cVALDT'>{ $VALDT }</column>\n<column name='cZTERM'>{ $ZTERM } { ' ' } { $ZTERM }</column>\n<column name='cVALTG'>{ $rs/VBKD/ROW/VALTG/text() }</column>\n<column name='cMRNKZ'>{ $rs/VBKD/ROW/MRNKZ/text() }</column>\n<column name='cFKDAT'>{ $FKDAT }</column>\n<column name='cIDENT'>{ $IDENT }</column>\n<column name='cBUKRS_VF'>{ $rs/VBAK/ROW/BUKRS_VF/text() } { ' ' } { $BUKRS_VF }</column>\n<column name='cFBUDA'>{ $rs/VBKD/ROW/FBUDA/text() }</column>\n<column name='cTAXK1'>{ $rs/VBAK/ROW/TAXK1/text() } { ' ' } { $rs/VBAK/ROW/TAXK2/text() } { ' ' } { $rs/VBAK/ROW/TAXK3/text() } { ' ' } { $rs/VBAK/ROW/TAXK4/text() } { ' ' } { $rs/VBAK/ROW/TAXK5/text() } { ' ' } { $rs/VBAK/ROW/TAXK6/text() } { ' ' } { $rs/VBAK/ROW/TAXK7/text() } { ' ' } { $rs/VBAK/ROW/TAXK8/text() } { ' ' } { $rs/VBAK/ROW/TAXK9/text() }</column>\n<column name='cLANDTX'>{ $rs/VBAK/ROW/LANDTX/text() }</column>\n<column name='cSTCEG_L'>{ $rs/VBAK/ROW/STCEG_L/text() }</column>\n<column name='cXEGDR'>{ $rs/VBAK/ROW/XEGDR/text() }</column>\n<column name='cABSSC'>{ $rs/VBKD/ROW/ABSSC/text() } { ' ' } { $ABSSC }</column>\n<column name='cLCNUM'>{ $rs/VBKD/ROW/LCNUM/text() }</column>\n<column name='cAKPRZ'>{ $rs/VBKD/ROW/AKPRZ/text() }</column>\n\n<column name='cKTGRD'>{ $KTGRD }</column>\n<column name='cZLSCH'>{ $rs/VBKD/ROW/ZLSCH/text() } { ' ' } { $LAND1 }</column>\n<column name='cPOPER'>{ $rs/VBKD/ROW/POPER/text() }</column>\n<column name='cKURRF'>{ $rs/VBKD/ROW/KURRF/text() }</column>\n<column name='cZUONR'>{ $rs/VBAK/ROW/ZUONR/text() }</column>\n<column name='cBUKRS_VF'>{ $BUKRS_VF }</column>\n<column name='cMSCHL'>{ $MSCHL }</column>\n<column name='cMANSP'>{ $MANSP}</column>\n<column name='cXBLNR'>{ $rs/VBAK/ROW/XBLNR/text() }</column>\n</row>\n\nreturn local:getResultsPage($rows, $page, $size)",
  "moduleNamespaces" : [ "urn:x-sig:sias:util:fn" ],
  "searchName" : "VA03 - Display Sales Order",
  "compositionName" : "VA03"
}