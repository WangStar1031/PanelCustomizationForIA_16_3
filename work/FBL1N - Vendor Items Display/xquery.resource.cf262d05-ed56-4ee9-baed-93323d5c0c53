{
  "createdBy" : "sue@iacustomer.com",
  "createdDate" : null,
  "lastModifiedBy" : "admin@sigma-sbs.com",
  "lastModifiedDate" : null,
  "name" : "1c71dd39-c2cc-4658-ae1c-14fb7ac39896",
  "query" : "import module namespace sias=\"urn:x-sig:sias:util:fn\";\n\n\ndeclare namespace ia = \"urn:x-emc:ia:schema:fn\";\ndeclare namespace table=\"urn:x-emc:ia:schema:table\";\n \ndeclare variable $page external;\ndeclare variable $size external;\n \n(: Our External Search variable matching the SAP Fieldname :)\ndeclare variable $sLIFNR external;\ndeclare variable $sBUKRS external;\ndeclare variable $sAUGDT external;\n \ndeclare function local:getResultsPage($rows, $page, $size) {\n  let $offset := $page * $size\n  let $total := count($rows)\n  return <results total=\"{ $total }\"> {\n    for $row in subsequence($rows, $offset + 1, $size)\n      return $row\n  } </results>\n};\n \ndeclare function local:addClause($whereClause as xs:string, $var as xs:string*, $expr as xs:string) as xs:string\n{\nif (empty($var) or $var = \"\")\nthen $whereClause\nelse if ($whereClause = \"\") then $expr else concat($whereClause, \" and \", $expr)\n};\n\ndeclare function local:get_bkpf($BUKRS,$BELNR,$GJAHR)\n{\n\nfor $bkpf in /SAP/BKPF/ROW\nwhere $bkpf/BUKRS = $BUKRS and $bkpf/BELNR = $BELNR and $bkpf/GJAHR = $GJAHR\nreturn \n<RS>\n<BKPF>{ $bkpf }</BKPF>\n</RS>\n};\n \n(: Build a conditional Where clause :)\nlet $frDate := substring(replace($sAUGDT/from,'-',''),1,8)\nlet $toDate := substring(replace($sAUGDT/to,'-',''),1,8)\n\nlet $whereClause := local:addClause(\"\", $sLIFNR, concat(\"contains($lfa1/LIFNR,&apos;\", $sLIFNR, \"&apos;)\" ))\nlet $whereClause := local:addClause($whereClause, $sBUKRS, concat(\"$lfb1/BUKRS = &apos;\", $sBUKRS, \"&apos;\"))\nlet $whereClause := local:addClause($whereClause, $frDate, concat(\"$bseg/AUGDT >= &apos;\", $frDate, \"&apos;\"))\nlet $whereClause := local:addClause($whereClause, $toDate, concat(\"$bseg/AUGDT <= &apos;\", $toDate, \"&apos;\"))\nlet $whereClause := if ($whereClause != \"\") then concat(\"where \", $whereClause) else $whereClause\n \nlet $query-str := concat(\"for $lfa1 in /SAP/LFA1/ROW, $lfb1 in /SAP/LFB1/ROW[LIFNR = $lfa1/LIFNR],$bseg in /SAP/BSEG/ROW[BUKRS = $lfb1/BUKRS and LIFNR = $lfa1/LIFNR]\", $whereClause, \"return <RS><LFA1>{ $lfa1 }</LFA1><LFB1>{ $lfb1 }</LFB1><BSEG>{ $bseg }</BSEG></RS>\")\n \nlet $main-query := xhive:evaluate($query-str)\nlet $rows :=\n               for $rs in $main-query\n   \n   let $bkpf := local:get_bkpf($rs/BSEG/ROW/BUKRS/text(),$rs/BSEG/ROW/BELNR/text(),$rs/BSEG/ROW/GJAHR/text())\n   let $ZFBDT := sias:showdate($rs/BSEG/ROW/ZFBDT/text())\n   let $AUGDT := sias:showdate($rs/BSEG/ROW/AUGDT/text())\n   let $ZTERM := sias:get_t052u($rs/LFB1/ROW/ZTERM/text())\n   let $SHKZG := sias:isnegative($rs/BSEG/ROW/DMBTR/text(), $rs/BSEG/ROW/SHKZG/text())\n   let $FDTAG := sias:showdate($rs/BSEG/ROW/FDTAG/text())\n   let $BUKRS := sias:get_t001($rs/BSEG/ROW/BUKRS/text(), \"BUTXT\")\n   let $WAERS := sias:get_t001($rs/BSEG/ROW/BUKRS/text(), \"WAERS\")\n   let $HKONT := sias:trimzero($rs/BSEG/ROW/HKONT/text())\n   let $LIFNR := sias:trimzero($rs/LFA1/ROW/LIFNR/text())\n  \n   \n   let $BLDAT := sias:showdate($bkpf/BKPF/ROW/BLDAT/text())\n   let $BUDAT := sias:showdate($bkpf/BKPF/ROW/BUDAT/text())\n   let $CPUDT := sias:showdate($bkpf/BKPF/ROW/CPUDT/text())\n   let $T003T := sias:get_t003t($bkpf/BKPF/ROW/BLART/text())\n   let $CPUTM := sias:showtime($bkpf/BKPF/ROW/CPUTM/text()) \n   \nreturn\n<row id='{string($rs/LFA1/ROW/@table:id)}'>\n<column name='cVendor'>{ $LIFNR }{'\t  '}{ $rs/LFA1/ROW/NAME1/text() }</column>\n<column name='cCode'>{ $rs/BSEG/ROW/BUKRS/text() }{'\t'}{ $rs/LFA1/ROW/STRAS/text() }</column>\n<column name='cName'>{ $BUKRS }{'\t'}{ $rs/LFA1/ROW/ORT01/text() }</column>\n<column name='cHKONT'>{ $HKONT }</column>\n<column name='cLIFNR'>{ $LIFNR }</column>\n<column name='cBELNR'>{ $rs/BSEG/ROW/BELNR/text() }</column>\n<column name='cAmount'>{ $rs/BSEG/ROW/WRBTR/text() }{ '        ' }{ $bkpf/BKPF/ROW/WAERS/text() }</column>\n<column name='cMWSKZ'>{ $rs/BSEG/ROW/MWSKZ/text() }</column>\n<column name='cBusiness'>{ $rs/BSEG/ROW/GSBER/text() }</column>\n<column name='cSKFBT'>{ $rs/BSEG/ROW/SKFBT/text() }{ '        ' }{ $bkpf/BKPF/ROW/WAERS/text() }</column>\n<column name='cUMSKZ'>{ $rs/BSEG/ROW/UMSKZ/text() }</column>\n<column name='cZTERM'>{ $rs/LFB1/ROW/ZTERM/text() }{ '     ' }{ $ZTERM }</column>\n<column name='cZTERM1'>{ $rs/LFB1/ROW/ZTERM/text() }{ '     ' }{  $ZTERM }</column>\n<column name='cMWSKZ'>{ $rs/BSEG/ROW/MWSKZ/text() }</column>\n<column name='cDMBTR'>{ $SHKZG }</column>\n<column name='cZFBDT'>{ $ZFBDT }</column>\n<column name='cZLSPR'>{ $rs/BSEG/ROW/ZLSPR/text() }</column>\n<column name='cPYCUR'>{ $rs/BSEG/ROW/PYCUR/text() }</column>\n<column name='cZLSCH'>{ $rs/BSEG/ROW/ZLSCH/text() }</column>\n<column name='cZUONR'>{ $rs/BSEG/ROW/ZUONR/text() }</column>\n<column name='cAUGBL'>{ $rs/BSEG/ROW/AUGBL/text() }</column>\n<column name='cBLART'>{ $bkpf/BKPF/ROW/BLART/text() }</column>\n<column name='cBLDAT'>{ $BLDAT }</column>\n<column name='cWAERS'>{ $WAERS }</column>\n<column name='cWSKTO'>{ $rs/BSEG/ROW/WSKTO/text() }{ '        ' }{ $rs/BKPF/ROW/WAERS/text() }</column>\n<column name='cDays'>{ $rs/BSEG/ROW/ZBD1T/text() }{ '     ' }{ $rs/BSEG/ROW/ZBD1P/text() }% { $rs/BSEG/ROW/ZBD2T/text() } { '  \t' } { $rs/BSEG/ROW/ZBD2P/text() }% { $rs/BSEG/ROW/ZBD3T/text() }</column>\n<column name='cZBFIX'>{ $rs/BSEG/ROW/ZBFIX/text() }</column>\n<column name='cInvoice'>{ $rs/BSEG/ROW/REBZG/text() } / { $rs/BSEG/ROW/REBZJ/text() } / { $rs/BSEG/ROW/REBZZ/text() }</column>\n<column name='cPYAMT'>{ $rs/BSEG/ROW/PYAMT/text() }</column>\n<column name='cSGTXT'>{ $rs/BSEG/ROW/SGTXT/text() }</column>\n<column name='cBUKRS'>{ $rs/LFB1/ROW/BUKRS/text() }</column>\n<column name='cBUKRS1'>{ $rs/LFB1/ROW/BUKRS/text() }{ '     ' }{ $BUKRS }</column>\n<column name='cNAME1'>{ $rs/LFA1/ROW/NAME1/text() }</column>\n<column name='cSTRAS'>{ $rs/LFA1/ROW/STRAS/text() }</column>\n<column name='cZSABE'>{ $rs/LFB1/ROW/ZSABE/text() }</column>\n<column name='cTELF1'>{ $rs/LFA1/ROW/TELF1/text() }</column>\n<column name='cINTAD'>{ $rs/LFB1/ROW/INTAD/text() }</column>\n<column name='cEIKTO'>{ $rs/LFB1/ROW/EIKTO/text() }</column>\n<column name='cKVERM'>{ $rs/LFB1/ROW/KVERM/text() }</column>\n<column name='cCity'>{ $rs/LFA1/ROW/ORT01/text() }{ '     ' }{ $rs/LFA1/ROW/PSTLZ/text() }</column>\n<column name='cClearing'>{ $AUGDT }{ '     ' }{ $rs/BSEG/ROW/AUGBL/text() }</column>\n\n<column name='cDocument'>{ $rs/BKPF/ROW/BLART/text() }{ '     ' }{ $T003T }</column>\n<column name='cBKTXT'>{ $bkpf/BKPF/ROW/BKTXT/text() }</column>\n<column name='cCCINS'>{ $bkpf/BKPF/ROW/CCINS/text() }</column>\n<column name='cCCNUM'>{ $bkpf/BKPF/ROW/CCNUM/text() }</column>\n<column name='cLOTKZ'>{ $bkpf/BKPF/ROW/LOTKZ/text() }</column>\n<column name='cXBLNR'>{ $bkpf/BKPF/ROW/XBLNR/text() }</column>\n<column name='cBLDAT1'>{ $BLDAT }</column>\n<column name='cBUDAT1'>{ $BUDAT }</column>\n<column name='cPosting'>{ $rs/BKPF/ROW/MONAT/text() } / { '     ' }{ $rs/BKPF/ROW/GJAHR/text() }</column>\n<column name='cWAERS1'>{ $rs/BKPF/ROW/WAERS/text() }</column>\n<column name='cAWTYP'>{ $bkpf/BKPF/ROW/AWTYP/text() }</column>\n<column name='cAWKEY'>{ $bkpf/BKPF/ROW/AWKEY/text() }</column>\n<column name='cUSNAM'>{ $bkpf/BKPF/ROW/USNAM/text() }</column>\n<column name='cCPUDT'>{ $CPUDT }</column>\n<column name='cCPUTM'>{ $CPUTM }</column>\n<column name='cPPNAM'>{ $bkpf/BKPF/ROW/PPNAM/text() }</column>\n<column name='cTCODE'>{ $bkpf/BKPF/ROW/TCODE/text() }</column>\n<column name='cAEDAT'>{ $bkpf/BKPF/ROW/AEDAT/text() }</column>\n<column name='cUPDDT'>{ $bkpf/BKPF/ROW/UPDDT/text() }</column>\n<column name='cLDGRP'>{ $bkpf/BKPF/ROW/LDGRP/text() }</column>\n<column name='cXREF1_HD'>{ $bkpf/BKPF/ROW/XREF1_HD/text() }</column>\n<column name='cXREF2_HD'>{ $bkpf/BKPF/ROW/XREF2_HD/text() }</column>\n\n<column name='cHouse'>{ $rs/BSEG/ROW/HBKID/text() }{ '     ' }{ $rs/BSEG/ROW/HKTID/text() }</column>\n<column name='cBVTYP'>{ $rs/BSEG/ROW/BVTYP/text() }</column>\n<column name='cDTWS'>{ $rs/BSEG/ROW/DTWS1/text() }{ '     ' }{ $rs/BSEG/ROW/DTWS2/text() }{ '     ' }{ $rs/BSEG/ROW/DTWS3/text() }{ '     ' }{ $rs/BSEG/ROW/DTWS4/text() }</column>\n<column name='cBDIFF'>{ $rs/BSEG/ROW/BDIFF/text() }</column>\n<column name='cBDIF2'>{ $rs/BSEG/ROW/BDIF2/text() }</column>\n<column name='cRDIFF'>{ $rs/BSEG/ROW/RDIFF/text() }</column>\n<column name='cRDIF2'>{ $rs/BSEG/ROW/RDIF2/text() }</column>\n<column name='cVBUND'>{ $rs/BSEG/ROW/VBUND/text() }</column>\n<column name='cANF'>{ $rs/BSEG/ROW/ANFBN/text() }{ '     ' }{ $rs/BSEG/ROW/ANFBU/text() }{ '     ' }{ $rs/BSEG/ROW/ANFBJ/text() }</column>\n<column name='cFDTAG'>{ $FDTAG }</column>\n<column name='cFDLEV'>{ $rs/BSEG/ROW/FDLEV/text() }</column>\n<column name='cCont'>{ $rs/BSEG/ROW/VERTN/text() } / { $rs/BSEG/ROW/VERTT/text() }</column>\n<column name='cVBEWA'>{ $rs/BSEG/ROW/VBEWA/text() }</column>\n<column name='cHZUON'>{ $rs/BSEG/ROW/HZUON/text() }</column>\n<column name='cCRCY'>{ $rs/BSEG/ROW/DMBE2/text() }{ '     ' }{ $rs/BSEG/ROW/HWAE2/text() }</column>\n<column name='cHard'>{ $rs/BSEG/ROW/DMBE3/text() }{ '     ' }{ $rs/BSEG/ROW/HWAE3/text() }</column>\n<column name='cXREF1'>{ $rs/BSEG/ROW/XREF1/text() }</column>\n<column name='cXREF2'>{ $rs/BSEG/ROW/XREF2/text() }</column>\n<column name='cXREF3'>{ $rs/BSEG/ROW/XREF3/text() }</column>\n\n</row>\n \nreturn local:getResultsPage($rows, $page, $size)",
  "moduleNamespaces" : [ "urn:x-sig:sias:util:fn" ],
  "searchName" : "FBL1N - Vendor Items Display",
  "compositionName" : "FBL1N"
}