{
  "createdBy" : "admin@sigma-sbs.com",
  "createdDate" : null,
  "lastModifiedBy" : "admin@sigma-sbs.com",
  "lastModifiedDate" : null,
  "name" : "568fc346-9ff1-45c1-a3bb-084ecbb453a4",
  "query" : "declare namespace ia = \"urn:x-emc:ia:schema:fn\";\ndeclare namespace table=\"urn:x-emc:ia:schema:table\";\nimport module namespace sias=\"urn:x-sig:sias:util:fn\";\n \ndeclare variable $page external;\ndeclare variable $size external;\n \n(: Our External Search variable matching the SAP Fieldname :)\ndeclare variable $sSAKNR external;\ndeclare variable $sBUKRS external;\ndeclare variable $sBUDAT external;\n \ndeclare function local:getResultsPage($rows, $page, $size) {\n  let $offset := $page * $size\n  let $total := count($rows)\n  return <results total=\"{ $total }\"> {\n    for $row in subsequence($rows, $offset + 1, $size)\n      return $row\n  } </results>\n};\n\ndeclare function local:addClause($whereClause as xs:string, $var as xs:string*, $expr as xs:string) as xs:string\n{\n\tif (empty($var) or $var = \"\")\n\tthen $whereClause\n\telse if ($whereClause = \"\") then $expr else concat($whereClause, \" and \", $expr)\n};\n\n(: Build a conditional Where clause :)\nlet $frDate := substring(replace($sBUDAT/from,'-',''),1,8)\nlet $toDate := substring(replace($sBUDAT/to,'-',''),1,8)\n\nlet $whereClause := local:addClause(\"\", $sBUKRS, concat(\"$bkpf/BUKRS = &apos;\", $sBUKRS, \"&apos;\" ))\nlet $whereClause := local:addClause($whereClause, $sSAKNR, concat(\"contains($bseg/HKONT, &apos;\", $sSAKNR, \"&apos;)\" ))\nlet $whereClause := local:addClause($whereClause, $frDate, concat(\"$bkpf/BUDAT >= &apos;\", $frDate, \"&apos;\"))\nlet $whereClause := local:addClause($whereClause, $toDate, concat(\"$bkpf/BUDAT <= &apos;\", $toDate, \"&apos;\"))\nlet $whereClause := if ($whereClause != \"\") then concat(\"where \", $whereClause) else $whereClause\n\nlet $query-str := concat(\"for $bkpf in /SAP/BKPF/ROW, $bseg in /SAP/BSEG/ROW[BUKRS=$bkpf/BUKRS and BELNR=$bkpf/BELNR and KOART='S' and GJAHR=$bkpf/GJAHR]\", $whereClause, \"  return <RS><BSEG>{ $bseg }</BSEG><BKPF>{ $bkpf }</BKPF></RS>\")\n\nlet $main-query := xhive:evaluate($query-str)\nlet $rows := \n\tfor $rs in $main-query           \n    \n    let $KTOPL := sias:get_t001($rs/BSEG/ROW/BUKRS/text(), \"KTOPL\")\n    let $BUKRS := sias:get_t001($rs/BSEG/ROW/BUKRS/text(), \"BUTXT\")\n    let $WAERS := sias:get_t001($rs/BSEG/ROW/BUKRS/text(), \"WAERS\")\n    let $TXT50 := sias:get_skat($KTOPL, $rs/BSEG/ROW/HKONT/text(),'TXT50')\n    let $DMBTR := sias:isnegative($rs/BSEG/ROW/DMBTR/text(), $rs/BSEG/ROW/SHKZG/text())\n    let $BUTXT := concat($rs/BSEG/ROW/BUKRS/text(),\" [\",sias:get_t001($rs/BSEG/ROW/BUKRS/text(), 'BUTXT'),\"]\")\n    let $GL := sias:trimzero($rs/BSEG/ROW/HKONT/text())\n    let $BLDAT := sias:showdate($rs/BKPF/ROW/BLDAT/text())\n    let $BUDAT := sias:showdate($rs/BKPF/ROW/BUDAT/text())\n    let $AEDAT := sias:showdate($rs/BKPF/ROW/AEDAT/text())\n    let $UPDDT := sias:showdate($rs/BKPF/ROW/UPDDT/text())\n    let $CPUDT := sias:showdate($rs/BKPF/ROW/CPUDT/text())\n    let $CPUTM := sias:showtime($rs/BKPF/ROW/CPUTM/text())\n    let $VALUT := sias:showdate($rs/BSEG/ROW/VALUT/text())\n    let $AUGDT := sias:showdate($rs/BSEG/ROW/AUGDT/text())\n    let $T003T := sias:get_t003t($rs/BKPF/ROW/BLART/text())\n    let $AMOUNT := sias:currency($rs/BSEG/ROW/DMBTR/text(), $rs/BSEG/ROW/SHKZG/text())\n    order by $rs/BKPF/ROW/BELNR\n    \n    return\n\n(: Faire afficher mon (G/L Accompte/Texte - Company Code :)\n<row id=\"{string($rs/BKPF/ROW/@table:id)}\">\n\t<column name='cWHERE'>{ $whereClause }</column>\n\n\t<column name='cBUKRS'>{ $rs/BSEG/ROW/BUKRS/text() }</column>\n    <column name='cBUKRS2'>{ $rs/BSEG/ROW/BUKRS/text() }{ '    ' }{ $BUKRS }</column>\n    <column name='KTOPL'>{ $rs/BSEG/ROW/KTOPL/text() }</column>\t\n    <column name='cHKONT'>{ $GL } { ' ' } { $TXT50}</column>\t\n    <column name='TXT50'>{ $TXT50 }</column>\n    <column name='cHKONT_2'>{ $GL }</column>\t\n    <column name='cBUKRS_2'>{ $rs/BSEG/ROW/BUKRS/text() }</column>\n    <column name='cWRBTR'>{ $rs/BSEG/ROW/WRBTR/text() } { ' ' } {$WAERS}</column>\n    <column name='cPARGB'>{ $rs/BSEG/ROW/PARGB/text() }</column>\n    <column name='cPROJK'>{ $rs/BSEG/ROW/PROJK/text() }</column>\n    <column name='cVALUT'>{ $VALUT }</column>\n    <column name='cAUGDT'>{ $AUGDT }{'     '}{ $rs/BSEG/ROW/AUGBL/text() }</column>\n    \n    <column name='cZUONR'>{ $rs/BSEG/ROW/ZUONR/text() }</column>\n    <column name='cBELNR_2'>{ $rs/BKPF/ROW/BELNR/text() }</column>\n    <column name='cGJAHR'>{ $rs/BSEG/ROW/GJAHR/text() }</column>\n    <column name='cBUDAT'>{ $BUDAT }</column>\n    <column name='cMONAT'>{ $rs/BKPF/ROW/MONAT/text() }</column>\n    <column name='cXBLNR'>{ $rs/BKPF/ROW/XBLNR/text() }</column>\n    <column name='cBVORG'>{ $rs/BKPF/ROW/BVORG/text() }</column>\n    <column name='cWAERS_2'>{ $rs/BKPF/ROW/WAERS/text() }</column>\n    <column name='cLDGRP'>{ $rs/BKPF/ROW/LDGRP/text() }</column>\n    <column name='cBLART_2'>{ $rs/BKPF/ROW/BLART/text() }</column>\n    <column name='cBKTXT'>{ $rs/BKPF/ROW/BKTXT/text() }</column>\n    <column name='cCCINS'>{ $rs/BKPF/ROW/CCINS/text() }</column>\n    <column name='cCCNUM'>{ $rs/BKPF/ROW/CCNUM/text() }</column>\n    <column name='cZUONR'>{ $rs/BSEG/ROW/ZUONR/text() }</column>\n    <column name='cLOTKZ'>{ $rs/BKPF/ROW/LOTKZ/text() }</column>\n    <column name='cXBLNR_2'>{ $rs/BKPF/ROW/XBLNR/text() }</column>\n    <column name='cBLDAT_3'>{ $BLDAT }</column>\n    <column name='cBUDAT_3'>{ $BUDAT }</column>\n    <column name='cWAERS_3'>{ $rs/BKPF/ROW/WAERS/text() }</column>\n    <column name='cMONAT_3'>{ $rs/BKPF/ROW/MONAT/text() }/{ $rs/BKPF/ROW/GJAHR/text() }</column>\n    <column name='cAWTYP'>{ $rs/BKPF/ROW/AWTYP/text() }</column>\n    <column name='cAWKEY'>{ $rs/BKPF/ROW/AWKEY/text() }</column>\n    <column name='cAWSYS'>{ $rs/BKPF/ROW/AWSYS/text() }</column>\n    <column name='cUSNAM'>{ $rs/BKPF/ROW/USNAM/text() }</column>\n    <column name='cPPNAM'>{ $rs/BKPF/ROW/PPNAM/text() }</column>\n    \n    <column name='cCPUDT'>{ $CPUDT }</column>\n    <column name='cCPUTM'>{ $CPUTM }</column>\n    <column name='cTCODE'>{ $rs/BKPF/ROW/TCODE/text() }</column>\n    <column name='cAEDAT'>{ $AEDAT }</column>\n    <column name='cUPDDT'>{ $UPDDT }</column>\n    \n    <column name='cSTBLG'>{ $rs/BKPF/ROW/STBLG/text() }{'     '}{ $rs/BKPF/ROW/STJAH/text() }</column>\n    <column name='cSTGRD'>{ $rs/BKPF/ROW/STGRD/text() }</column>\n    <column name='cLDGRP_3'>{ $rs/BKPF/ROW/LDGRP/text() }</column>\n    <column name='cXREF1_HD'>{ $rs/BKPF/ROW/XREF1_HD/text() }</column>\n    <column name='cXREF2_HD'>{ $rs/BKPF/ROW/XREF2_HD/text() }</column>\n    <column name='cBUKRS_3'>{ $rs/BSEG/ROW/BUKRS/text() }</column>\n    \n    <column name='cZUONR!!'>{ $rs/BSEG/ROW/ZUONR/text() }</column>\n\t<column name='cBELNR'>{ $rs/BKPF/ROW/BELNR/text() }</column>\n    <column name='cGSBER'>{ $rs/BSEG/ROW/GSBER/text() }</column>\n    <column name='cBLART'>{ $rs/BKPF/ROW/BLART/text() }</column>\n    <column name='cBLDAT'>{ $BLDAT }</column>\n    <column name='cBSCHL'>{ $rs/BSEG/ROW/BSCHL/text() }</column>\n    \n    <column name='cAMOUNT'>{ $AMOUNT }</column>\n    <column name='cDMBTR'>{ $DMBTR }</column>\n    \n\t<column name='cWAERS'>{ $WAERS }</column>\n\t<column name='cMWSKZ'>{ $rs/BSEG/ROW/MWSKZ/text() }</column>\n\t<column name='cAUGBL'>{ $rs/BSEG/ROW/AUGBL/text() }</column>\n\t<column name='cPRCTR'>{ sias:trimzero($rs/BSEG/ROW/PRCTR/text()) }</column>\n\t<column name='cSEGMENT'>{ $rs/BSEG/ROW/SEGMENT/text() }</column>\n    <column name='cSGTXT'>{ $rs/BSEG/ROW/SGTXT/text() }</column>\n        \n</row>\n \nreturn local:getResultsPage($rows, $page, $size)",
  "moduleNamespaces" : [ "urn:x-sig:sias:util:fn" ],
  "searchName" : "FBL3N - GL Account line Item Display",
  "compositionName" : "FBL3N"
}