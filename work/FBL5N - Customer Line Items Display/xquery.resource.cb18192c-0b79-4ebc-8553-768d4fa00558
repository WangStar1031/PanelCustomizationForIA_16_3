{
  "createdBy" : "sue@iacustomer.com",
  "createdDate" : null,
  "lastModifiedBy" : "admin@sigma-sbs.com",
  "lastModifiedDate" : null,
  "name" : "681185a4-707c-4d11-a232-ff2777095d33",
  "query" : "declare namespace ia = \"urn:x-emc:ia:schema:fn\";\ndeclare namespace table=\"urn:x-emc:ia:schema:table\";\n\nimport module namespace sias=\"urn:x-sig:sias:util:fn\";\n\n \ndeclare variable $page external;\ndeclare variable $size external;\n \n(: Our External Search variable matching the SAP Fieldname :)\ndeclare variable $sKUNNR external;\ndeclare variable $sBUKRS external;\ndeclare variable $sAUGDT external;\n \ndeclare function local:getResultsPage($rows, $page, $size) {\n  let $offset := $page * $size\n  let $total := count($rows)\n  return <results total=\"{ $total }\"> {\n    for $row in subsequence($rows, $offset + 1, $size)\n      return $row\n  } </results>\n};\n \ndeclare function local:addClause($whereClause as xs:string, $var as xs:string*, $expr as xs:string) as xs:string\n{\nif (empty($var) or $var = \"\")\nthen $whereClause\nelse if ($whereClause = \"\") then $expr else concat($whereClause, \" and \", $expr)\n};\n\ndeclare function local:get_bkpf($BUKRS,$BELNR,$GJAHR)\n{\nfor $bkpf in /SAP/BKPF/ROW\nwhere $bkpf/BUKRS = $BUKRS and $bkpf/BELNR = $BELNR and $bkpf/GJAHR = $GJAHR\nreturn \n<RS>\n<BKPF>{ $bkpf }</BKPF>\n</RS>\n};\n(: Build a conditional Where clause :)\nlet $frDate := substring(replace($sAUGDT/from,'-',''),1,8)\nlet $toDate := substring(replace($sAUGDT/to,'-',''),1,8)\n\nlet $whereClause := local:addClause(\"\", $sKUNNR, concat(\"contains($bseg/KUNNR,&apos;\", $sKUNNR, \"&apos;)\" ))\nlet $whereClause := local:addClause($whereClause, $sBUKRS, concat(\"contains($bseg/BUKRS,&apos;\", $sBUKRS, \"&apos;)\"))\nlet $whereClause := local:addClause($whereClause, $frDate, concat(\"$bseg/AUGDT >= &apos;\", $frDate, \"&apos;\"))\nlet $whereClause := local:addClause($whereClause, $toDate, concat(\"$bseg/AUGDT <= &apos;\", $toDate, \"&apos;\"))\nlet $whereClause := if ($whereClause != \"\") then concat(\"where \", $whereClause) else $whereClause\n \nlet $query-str := concat(\"for $bseg in /SAP/BSEG/ROW, $kna1 in /SAP/KNA1/ROW[KUNNR = $bseg/KUNNR], $knb1 in /SAP/KNB1/ROW[KUNNR = $bseg/KUNNR and BUKRS = $bseg/BUKRS]\", $whereClause, \"return <RS><BSEG>{ $bseg }</BSEG><KNA1>{ $kna1 }</KNA1><KNB1>{ $knb1 }</KNB1></RS>\")\n \nlet $main-query := xhive:evaluate($query-str)\nlet $rows :=\n               for $rs in $main-query\n               \n        let $bkpf := local:get_bkpf($rs/BSEG/ROW/BUKRS/text(),$rs/BSEG/ROW/BELNR/text(),$rs/BSEG/ROW/GJAHR/text())       \n        let $BLDAT := sias:showdate($bkpf/BKPF/ROW/BLDAT/text())\n\t\tlet $BLART := $bkpf/BKPF/ROW/BLART/text()\n        let $AUGDT := sias:showdate($rs/BSEG/ROW/AUGDT/text())\n        let $ZFBDT := sias:showdate($rs/BSEG/ROW/ZFBDT/text())\n        let $AEDAT := sias:showdate($rs/BSEG/ROW/AEDAT/text())\n        let $UPDDT := sias:showdate($rs/BSEG/ROW/UPDDT/text())\n        let $T001 := sias:get_t001($rs/BSEG/ROW/BUKRS, \"BUTXT\")\n        let $WAERS := sias:get_t001($rs/BSEG/ROW/BUKRS, \"WAERS\")\n\t\tlet $CPUDT := sias:showdate($bkpf/BKPF/ROW/CPUDT/text())\n\t\tlet $T003T := sias:get_t003t($bkpf/BKPF/ROW/BLART/text())\n\t\tlet $CPUTM := sias:showtime($bkpf/BKPF/ROW/CPUTM/text())\n        let $BUDAT := sias:showdate($bkpf/BKPF/ROW/BUDAT/text())\n        let $KUNNR := sias:trimzero($rs/KNA1/ROW/KUNNR/text())\n        let $HKONT := sias:trimzero($rs/BSEG/ROW/HKONT/text())\n        let $BELNR := $rs/BSEG/ROW/BELNR/text()\n        let $WRBTR := sias:trimzero($rs/BSEG/ROW/WRBTR/text())\n        let $SHKZG := sias:isnegative($rs/BSEG/ROW/DMBTR/text(), $rs/BSEG/ROW/SHKZG/text())\n        let $VERTN := sias:trimzero($rs/BSEG/ROW/VERTN/text())\n        let $SKFBT := sias:currency($rs/BSEG/ROW/SKFBT/text(), \"\")\n        let $WSKTO := sias:currency($rs/BSEG/ROW/WSKTO/text(), \"\")\n        let $PYAMT := sias:currency($rs/BSEG/ROW/PYAMT/text(), \"\")\n        let $DMBE2 := sias:currency($rs/BSEG/ROW/DMBE2/text(), \"\")\n        let $DMBE3 := sias:currency($rs/BSEG/ROW/DMBE3/text(), \"\")\n        \n   \nreturn\n<row id='{string($rs/KNA1/ROW/@table:id)}'>\n<column name='cVendor'>{ $KUNNR }{'\t  '}{ $rs/KNA1/ROW/NAME1/text() }</column>\n<column name='cCode'>{ $rs/BSEG/ROW/BUKRS/text() }{'\t'}{ $rs/KNA1/ROW/STRAS/text() }</column>\n<column name='cName'>{ $T001 }{'\t'}{ $rs/KNA1/ROW/ORT01/text() }</column>\n<column name='cHKONT'>{ $HKONT }</column>\n<column name='cCustomer'>{ $KUNNR }{'      '}{ $rs/KNA1/ROW/NAME1/text() }</column>\n<column name='cKUNNR'>{ $KUNNR }</column>\n<column name='cBUKRS'>{ $rs/KNB1/ROW/BUKRS/text() }</column>\n<column name='cBUKRS1'>{ $rs/KNB1/ROW/BUKRS/text() }{ '     ' }{ $T001 }</column>\n<column name='cBELNR'>{ $BELNR }</column>\n<column name='cAmount'>{ $WRBTR }{'\t'}{ $bkpf/BKPF/ROW/WAERS/text() }</column>\n<column name='cBLDAT'>{ $BLDAT }</column>\n<column name='cLocal'>{ $SHKZG }{'\t'}{ $WAERS }</column>\n<column name='cGSBER'>{ $rs/BSEG/ROW/GSBER/text() }</column> \n<column name='cBLART'>{ $BLART }</column>\n<column name='cZTERM'>{ $rs/KNB1/ROW/ZTERM/text() }</column> \n<column name='cDMBTR'>{ $SHKZG }</column>\n<column name='cZFBDT'>{ $ZFBDT }</column>\n<column name='cZLSPR'>{ $rs/BSEG/ROW/ZLSPR/text() }</column>\n<column name='cPYCUR'>{ $rs/BSEG/ROW/PYCUR/text() }</column>\n<column name='cWAERS'>{ $WAERS }</column>\n<column name='cZUONR'>{ $rs/BSEG/ROW/ZUONR/text() }</column>\n<column name='cAUGDT'>{ $AUGDT }</column>\n<column name='cVBEWA'>{ $rs/BSEG/ROW/VBEWA/text() }</column>\n<column name='cMABER'>{ $rs/BSEG/ROW/MABER/text() }</column>\n<column name='cMSCHL'>{ $rs/BSEG/ROW/MSCHL/text() }</column>\n<column name='cBase'>{ $SKFBT } {'\t'} { $WAERS }</column>\n<column name='cDunned'>{ $rs/BSEG/ROW/MADAT/text() } {'\t'} { $rs/BSEG/ROW/MANST/text() }</column>\n<column name='cContract'>{ $VERTN } {'\t'} { $rs/BSEG/ROW/VERTT/text() }</column>\n<column name='cClearing'>{ $AUGDT } {'\t'} { $rs/BSEG/ROW/AUGBL/text() }</column>\n<column name='cDiscount'>{ $WSKTO } {'\t'} { $WAERS }</column>\n<column name='cDays'>{ $rs/BSEG/ROW/ZBD1T/text() }{'    '} { $rs/BSEG/ROW/ZBD1P/text() }% { $rs/BSEG/ROW/ZBD2T/text() }{ '\t' }{ $rs/BSEG/ROW/ZBD2P/text() }% { $rs/BSEG/ROW/ZBD3T/text() }</column>\n<column name='cKIDNO'>{ $rs/BSEG/ROW/KIDNO/text() }</column>\n<column name='cInvoice'>{ $rs/BSEG/ROW/REBZG/text() } / { $rs/BSEG/ROW/REBZJ/text() } / { $rs/BSEG/ROW/REBZZ/text() }</column>\n<column name='cPYAMT'>{ $PYAMT }{ $WAERS }</column>\n<column name='cSGTXT'>{ $rs/BSEG/ROW/SGTXT/text() }</column>\n<column name='cMWSKZ'>{ $rs/BSEG/ROW/MWSKZ/text() }</column>\n\n<column name='cNAME1'>{ $rs/KNA1/ROW/NAME1/text() }</column> \n<column name='cSTRAS'>{ $rs/KNA1/ROW/STRAS/text() }</column>\n<column name='cCity'>{ $rs/KNA1/ROW/ORT01/text() }{ '    ' }{ $rs/KNA1/ROW/PSTLZ/text() }</column>\n<column name='cTELF1'>{ $rs/KNA1/ROW/TELF1/text() }</column>\n<column name='cZSABE'>{ $rs/KNB1/ROW/ZSABE/text() }</column>\n<column name='cTLFNS'>{ $rs/KNB1/ROW/TLFNS/text() }</column>\n<column name='cINTAD'>{ $rs/KNB1/ROW/INTAD/text() }</column>\n<column name='cEIKTO'>{ $rs/KNB1/ROW/EIKTO/text() }</column>\n<column name='cKVERM'>{ $rs/KNB1/ROW/KVERM/text() }</column>\n\n\n<column name='cDocument'>{ $bkpf/BKPF/ROW/BLART/text() }{ '     ' }{ $T003T }</column>\n<column name='cBKTXT'>{ $bkpf/BKPF/ROW/BKTXT/text() }</column>\n<column name='cCCINS'>{ $bkpf/BKPF/ROW/CCINS/text() }</column>\n<column name='cCCNUM'>{ $bkpf/BKPF/ROW/CCNUM/text() }</column>\n<column name='cLOTKZ'>{ $bkpf/BKPF/ROW/LOTKZ/text() }</column>\n<column name='cXBLNR'>{ $bkpf/BKPF/ROW/XBLNR/text() }</column>\n<column name='cBLDAT1'>{ $BLDAT }</column>\n<column name='cBUDAT1'>{ $BUDAT }</column>\n<column name='cPosting'>{ $bkpf/BKPF/ROW/MONAT/text() } / { '     ' }{ $bkpf/BKPF/ROW/GJAHR/text() }</column>\n<column name='cWAERS1'>{ $bkpf/BKPF/ROW/WAERS/text() }</column>\n<column name='cAWTYP'>{ $bkpf/BKPF/ROW/AWTYP/text() }</column>\n<column name='cAWKEY'>{ $bkpf/BKPF/ROW/AWKEY/text() }</column>\n<column name='cUSNAM'>{ $bkpf/BKPF/ROW/USNAM/text() }</column>\n<column name='cCPUDT'>{ $CPUDT }</column>\n<column name='cCPUTM'>{ $CPUTM }</column>\n<column name='cPPNAM'>{ $bkpf/BKPF/ROW/PPNAM/text() }</column>\n<column name='cTCODE'>{ $bkpf/BKPF/ROW/TCODE/text() }</column>\n<column name='cAEDAT'>{ $AEDAT }</column>\n<column name='cUPDDT'>{ $UPDDT }</column>\n<column name='cLDGRP'>{ $bkpf/BKPF/ROW/LDGRP/text() }</column>\n<column name='cXREF1_HD'>{ $bkpf/BKPF/ROW/XREF1_HD/text() }</column>\n<column name='cXREF2_HD'>{ $bkpf/BKPF/ROW/XREF2_HD/text() }</column>\n\n\n<column name='cHouse'>{ $rs/BSEG/ROW/HBKID/text() }{ '     ' }/ { $rs/BSEG/ROW/HKTID/text() }</column>\n<column name='cZLSCH'>{ $rs/BSEG/ROW/ZLSCH/text() }</column>\n<column name='cBVTYP'>{ $rs/BSEG/ROW/BVTYP/text() }</column>\n<column name='cDTWS'>{ $rs/BSEG/ROW/DTWS1/text() }{ '     ' }{ $rs/BSEG/ROW/DTWS2/text() }{ '     ' }{ $rs/BSEG/ROW/DTWS3/text() }{ '     ' }{ $rs/BSEG/ROW/DTWS4/text() }</column>\n<column name='cVBUND'>{ $rs/BSEG/ROW/VBUND/text() }</column>\n<column name='cANF'>{ $rs/BSEG/ROW/ANFBN/text() }{ '     ' }{ $rs/BSEG/ROW/ANFBU/text() }{ '     ' }{ $rs/BSEG/ROW/ANFBJ/text() }</column>\n<column name='cKKBER'>{ $rs/BSEG/ROW/KKBER/text() }</column>\n<column name='cVBELN'>{ $rs/BSEG/ROW/VBELN/text() }</column>\n<column name='cRSTGR'>{ $rs/BSEG/ROW/RSTGR/text() }</column>\n<column name='cHZUON'>{ $rs/BSEG/ROW/HZUON/text() }</column>\n<column name='cCRCY'>{ $DMBE2 }{ '     ' }{ $bkpf/BKPF/ROW/HWAE2/text() }</column>\n<column name='cHard'>{ $DMBE3 }{ '     ' }{ $bkpf/BKPF/ROW/HWAE3/text() }</column>\n<column name='cXREF1'>{ $rs/BSEG/ROW/XREF1/text() }</column>\n<column name='cXREF2'>{ $rs/BSEG/ROW/XREF2/text() }</column>\n<column name='cXREF3'>{ $rs/BSEG/ROW/XREF3/text() }</column>\n\n</row>\n \nreturn local:getResultsPage($rows, $page, $size)",
  "moduleNamespaces" : [ "urn:x-sig:sias:util:fn" ],
  "searchName" : "FBL5N - Customer Line Items Display",
  "compositionName" : "FBL5N"
}